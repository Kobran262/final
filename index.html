<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Среħа 2024 - Система управления документами</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f8f9fa, #e9ecef); min-height: 100vh; padding: 20px; color: #212529; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); overflow: hidden; border: 2px solid #dee2e6; }
        .header { background: linear-gradient(135deg, #212529, #343a40); color: white; padding: 30px; display: flex; align-items: center; gap: 20px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 16px; }
        .logo { width: 80px; height: 80px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #212529; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 3px solid #dee2e6; }
        .nav-tab { flex: 1; padding: 20px; text-align: center; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 600; color: #495057; transition: all 0.3s ease; }
        .nav-tab.active { background: white; color: #212529; border-bottom: 3px solid #212529; }
        .nav-tab:hover:not(.active) { background: #e9ecef; }
        .tab-content { display: none; padding: 30px; min-height: 600px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #212529; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #212529; box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1); }
        .btn { padding: 12px 24px; border: 2px solid transparent; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-right: 10px; margin-bottom: 10px; text-transform: uppercase; }
        .btn-primary { background: #212529; color: white; border-color: #212529; }
        .btn-primary:hover { background: #343a40; }
        .btn-success { background: #6c757d; color: white; border-color: #6c757d; }
        .btn-success:hover { background: #5a6268; }
        .btn-danger { background: white; color: #212529; border-color: #212529; }
        .btn-danger:hover { background: #212529; color: white; }
        .btn-secondary { background: white; color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background: #6c757d; color: white; }
        .table-container { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        .table th { background: #212529; color: white; padding: 15px 10px; text-align: left; font-weight: 600; }
        .table td { padding: 12px 10px; border-bottom: 1px solid #dee2e6; }
        .table tr:hover { background: #f8f9fa; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #212529, #343a40); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 8px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .chart-container { background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .chart-title { font-size: 20px; font-weight: bold; color: #212529; margin-bottom: 20px; text-align: center; }
        .filter-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .invoice-list { background: white; border-radius: 12px; padding: 20px; margin-top: 20px; border: 2px solid #e9ecef; }
        .invoice-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e9ecef; transition: background 0.3s ease; }
        .invoice-item:hover { background: #f8f9fa; }
        .invoice-item:last-child { border-bottom: none; }
        .invoice-info { flex: 1; }
        .invoice-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .invoice-status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #212529; color: white; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid; position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; }
        .alert-success { background: #f8f9fa; color: #212529; border-color: #6c757d; }
        .alert-danger { background: #f8f9fa; color: #212529; border-color: #212529; }
        .section-card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #e9ecef; }
        .company-info { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .invoice-items { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: end; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .delivery-items { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .totals { margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 8px; border: 2px solid #dee2e6; }
        .totals-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .totals-final { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #212529; margin-top: 15px; padding-top: 15px; border-top: 2px solid #212529; }
        .preview { background: white; border: 2px solid #dee2e6; border-radius: 12px; padding: 30px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .searchable-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .searchable-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .searchable-input:focus {
            outline: none;
            border-color: #212529;
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item.selected {
            background: #212529;
            color: white;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            border: 2px solid #dee2e6;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #212529, #343a40);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        .login-form h2 {
            text-align: center;
            color: #212529;
            margin-bottom: 25px;
        }
        .login-error {
            color: #dc3545;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        /* Стили для профиля клиента */
        .client-profile-modal {
            max-width: 1100px !important;
            max-height: 85vh !important;
            margin: 2% auto !important;
            padding: 0 !important;
        }

        .client-card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .client-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .client-title-info h2 {
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .client-title-info p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .profile-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .profile-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            height: fit-content;
        }

        .profile-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 13px;
            min-width: 100px;
        }

        .profile-field-value {
            color: #495057;
            font-size: 14px;
            text-align: right;
            flex: 1;
            max-width: 200px;
            word-wrap: break-word;
        }

        .profile-address {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .address-text {
            flex: 1;
            font-size: 14px;
            color: #495057;
        }

        .maps-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            min-width: 40px;
        }

        .maps-btn:hover {
            background: #218838;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .contact-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .contact-icon.phone { background: #f5f5f5; color: #333; }
        .contact-icon.email { background: #f0f0f0; color: #555; }
        .contact-icon.telegram { background: #e8e8e8; color: #444; }
        .contact-icon.instagram { background: #f8f8f8; color: #666; }

        .contact-value {
            font-size: 12px;
            color: #495057;
            word-break: break-all;
        }

        .collaboration-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .collab-tag {
            background: #f5f5f5;
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #ddd;
        }

        .collab-tag.installment { background: #e8e8e8; color: #333; border-color: #ccc; }
        .collab-tag.showcase { background: #f0f0f0; color: #444; border-color: #bbb; }
        .collab-tag.bar { background: #f8f8f8; color: #555; border-color: #ddd; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            grid-column: 1 / -1;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #dee2e6;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .profile-notes {
            grid-column: 1 / -1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            font-size: 13px;
            line-height: 1.5;
            color: #495057;
            max-height: 80px;
            overflow-y: auto;
        }

        .period-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            grid-column: 1 / -1;
        }

        .period-selector select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 13px;
        }

        /* Стили для сворачиваемой формы */
        .collapsible-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .section-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 20px;
        }

        .section-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .client-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 25px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .form-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            padding: 20px 25px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Стили для вкладок истории */
        .history-tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0;
        }

        .history-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-tab:hover {
            background: #f8f9fa;
            color: #333;
        }

        .history-tab.active {
            background: #333;
            color: white;
            font-weight: 600;
        }

        .history-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #333;
        }

        /* Стили для списка пользователей */
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #333;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .user-details h5 {
            margin: 0 0 5px 0;
            color: #333;
            font-weight: 600;
        }

        .user-details p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Адаптация под 1366x768 */
        @media screen and (max-width: 1400px) {
            .client-profile-modal {
                max-width: 95% !important;
                margin: 1% auto !important;
            }
            
            /* Адаптация модального окна логов для экранов 1366x768 */
            #logsModal .modal-content {
                max-width: 85vw !important;
                width: 700px !important;
                max-height: 80vh !important;
                margin: 3vh auto !important;
            }
        }
            
            .profile-sections {
                padding: 20px;
                gap: 15px;
                max-height: 65vh;
            }
            
            .profile-section {
                padding: 15px;
            }
            
            .client-card-header {
                padding: 15px 25px;
            }
            
            .client-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .client-title-info h2 {
                font-size: 20px;
            }
            
            .contact-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .client-form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }

            .form-section {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
            margin: 0;
        }
        .close {
            background: none;
            border: none;
            font-size: 30px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .close:hover {
            background: #f8f9fa;
            color: #212529;
        }
        @media (max-width: 768px) {
            .nav-tabs { flex-direction: column; }
            .nav-tab { min-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .invoice-items { grid-template-columns: 1fr; }
            .delivery-items { grid-template-columns: 1fr; }
            
            /* Адаптация модального окна логов для мобильных */
            #logsModal .modal-content {
                max-width: 95vw !important;
                width: 95vw !important;
                max-height: 90vh !important;
                margin: 2vh auto !important;
            }
            
            #logsModal .modal-footer {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            #logsModal .modal-footer button {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        /* Стили для склада */
        .warehouse-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .product-group {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .group-header {
            padding: 15px 20px;
            background: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .group-header:hover {
            background: #dee2e6;
        }

        .group-header h4 {
            margin: 0;
            color: #333;
        }

        .group-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .group-expand-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .group-expanded .group-expand-icon {
            transform: rotate(90deg);
        }

        .group-content {
            padding: 20px;
            display: none;
            border-top: 1px solid #dee2e6;
        }

        .group-expanded .group-content {
            display: block;
        }

        .group-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .remaining-percentage {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        .remaining-percentage.low {
            color: #dc3545;
        }

        .remaining-percentage.medium {
            color: #ffc107;
        }

        .add-products-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .products-in-group {
            margin-top: 15px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .quantity-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .group-info {
                flex-direction: column;
                gap: 5px;
            }
            
            .group-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Подсветка обязательных полей */
        .required-field {
            background-color: #F4E285 !important;
            border-color: #F4E285 !important;
        }

        .required-field-error {
            background-color: #F4A259 !important;
            border-color: #F4A259 !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Стили для лейблов обязательных полей */
        .required-label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Форма авторизации -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">СР</div>
                <h1>Среħа 2024</h1>
                <p>Система управления документами</p>
            </div>
            <div class="login-form">
                <h2>Вход в систему</h2>
                <div class="form-group">
                    <label>Логин:</label>
                    <input type="text" id="loginUsername" placeholder="Введите логин">
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="loginPassword" placeholder="Введите пароль">
                </div>
                <button class="btn btn-primary" onclick="authenticate()">Войти</button>
                <div id="loginError" class="login-error" style="display: none;">Неверный логин или пароль</div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 80px; height: auto; border-radius: 12px;">
            <div>
                <h1>Среħа 2024 ДОО</h1>
                <p>Система управления инвойсами и отпремницами</p>
                <p style="font-size: 14px; opacity: 0.8;">Београд, Стари Град, Мајке Јевросиме 35 | МБ: 22019309 | ПИБ: 114407658</p>
            </div>
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="openLogsModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">📋</span>
                    Логи
                </button>
                <button class="btn btn-secondary" onclick="openAddUserModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">👤</span>
                    Добавить пользователя
                </button>
                <button class="btn btn-secondary" onclick="openEditUsersModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">⚙️</span>
                    Редактировать пользователя
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clients')">Клиенты</button>
            <button class="nav-tab" onclick="showTab('products')">Товары</button>
            <button class="nav-tab" onclick="showTab('warehouse')">Склад</button>
            <button class="nav-tab" onclick="showTab('invoice')">Создать инвойс</button>
            <button class="nav-tab" onclick="showTab('delivery')">Создать отпремницу</button>
            <button class="nav-tab" onclick="showTab('statistics')">Статистика продаж</button>
        </div>

        <!-- Клиенты -->
        <div id="clients" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Управление клиентами</h2>
                <button class="btn btn-primary" onclick="toggleClientForm()" id="toggleFormBtn">
                    <span id="toggleIcon">➕</span> Добавить клиента
                </button>
            </div>
            
            <!-- Сворачиваемая форма создания клиента -->
            <div id="clientFormSection" class="collapsible-section" style="display: none;">
                <div class="section-header">
                    <h3>Создание нового клиента</h3>
                </div>
                
                <div class="client-form-grid">
                    <!-- Основная информация -->
                    <div class="form-section">
                        <h4>📋 Основная информация</h4>
                        <div class="form-group">
                            <label>Название компании *</label>
                            <input type="text" id="clientName" placeholder="Название компании">
                        </div>
                        <div class="form-group">
                            <label>Юридическое название *</label>
                            <input type="text" id="clientLegalName" placeholder="Полное юридическое название">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Матични број *</label>
                                <input type="text" id="clientMB" placeholder="Матични број">
                            </div>
                            <div class="form-group">
                                <label>ПИБ *</label>
                                <input type="text" id="clientPIB" placeholder="ПИБ">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Контактное лицо</label>
                                <input type="text" id="clientContactPerson" placeholder="Имя контактного лица">
                            </div>
                            <div class="form-group">
                                <label>Банковский счет</label>
                                <input type="text" id="clientBank" placeholder="Номер банковского счета">
                            </div>
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="form-section">
                        <h4>📍 Адрес</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="manualAddressInput" style="width: auto;">
                                Ручной ввод адреса
                            </label>
                        </div>
                        
                        <!-- Автоматический ввод адреса -->
                        <div id="autoAddressSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Город *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientCity" placeholder="Введите название города..." autocomplete="off">
                                        <div class="dropdown-menu" id="clientCityDropdown"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Община *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientMunicipality" placeholder="Выберите сначала город..." autocomplete="off" disabled>
                                        <div class="dropdown-menu" id="clientMunicipalityDropdown"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Улица *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientStreet" placeholder="Выберите сначала общину..." autocomplete="off" disabled>
                                        <div class="dropdown-menu" id="clientStreetDropdown"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Номер дома</label>
                                    <input type="text" id="clientHouseNumber" placeholder="Номер дома">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ручной ввод адреса -->
                        <div id="manualAddressSection" style="display: none;">
                            <div class="form-group">
                                <label>Полный адрес *</label>
                                <textarea id="clientManualAddress" placeholder="Введите полный адрес (например: Beograd, Stari grad, Knez Mihailova 5)" rows="3" style="resize: vertical;"></textarea>
                                <small style="color: #666; font-size: 12px;">Укажите полный адрес в произвольной форме</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ссылка на Google Maps</label>
                            <input type="text" id="clientGoogleMaps" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <!-- Контактные данные -->
                    <div class="form-section">
                        <h4>📞 Контактные данные</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Телефон</label>
                                <input type="text" id="clientPhone" placeholder="+381 XX XXX XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="clientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram</label>
                                <input type="text" id="clientTelegram" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="clientInstagram" placeholder="@username">
                            </div>
                        </div>
                    </div>

                    <!-- Условия сотрудничества -->
                    <div class="form-section">
                        <h4>🤝 Условия сотрудничества</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="clientInstallment" style="transform: scale(1.2);">
                                    <span>Рассрочка оплаты</span>
                                </label>
                                <input type="text" id="clientInstallmentTerm" placeholder="Срок (дни)" style="margin-top: 5px;">
                            </div>
                            <div class="form-group">
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="clientShowcase" style="transform: scale(1.2);">
                                        <span>Витрина</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="clientBar" style="transform: scale(1.2);">
                                        <span>Бар</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Примечания</label>
                            <textarea id="clientNotes" placeholder="Дополнительные примечания о клиенте" rows="3" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="addClient()">✅ Добавить клиента</button>
                    <button class="btn btn-secondary" onclick="clearClientForm()">🗑️ Очистить форму</button>
                    <button class="btn btn-secondary" onclick="toggleClientForm()">❌ Свернуть</button>
                </div>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr><th>Название</th><th>МБ</th><th>ПИБ</th><th>Адрес</th><th>Контакт</th><th>Банк</th><th>Действия</th></tr>
                    </thead>
                    <tbody id="clientsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Товары -->
        <div id="products" class="tab-content">
            <h2>Управление товарами</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>Код товара *</label>
                        <input type="text" id="productCode" placeholder="GF-B-TG210">
                    </div>
                    <div class="form-group">
                        <label>Название товара *</label>
                        <input type="text" id="productName" placeholder="Tieguanyin/Zeleni Čaj 210g">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Стоимость без НДС (RSD) *</label>
                        <input type="number" id="productPrice" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Категория</label>
                        <select id="productCategory">
                            <option value="">Выберите категорию</option>
                            <option value="Zeleni Čaj">Зеленый чай</option>
                            <option value="Crni Čaj">Черный чай</option>
                            <option value="Printing">Полиграфия</option>
                            <option value="Other">Другое</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Вес (г)</label>
                        <input type="number" id="productWeight" placeholder="210" step="0.1">
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="addProduct()">Добавить товар</button>
            <button class="btn btn-secondary" onclick="clearProductForm()">Очистить форму</button>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr><th>Код</th><th>Название</th><th>Цена (RSD)</th><th>Категория</th><th>Вес (г)</th><th>Действия</th></tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Склад -->
        <div id="warehouse" class="tab-content">
            <h2>Управление складом</h2>
            
            <!-- Форма создания группы товаров -->
            <div class="warehouse-section">
                <h3>Создать группу товаров</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Название группы *</label>
                        <input type="text" id="groupName" placeholder="Зеленый чай премиум">
                    </div>
                    <div class="form-group">
                        <label>Дата отгрузки</label>
                        <input type="date" id="groupShipmentDate">
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Количество</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupQuantityType" style="flex: 0 0 80px;">
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="groupQuantity" placeholder="1000" style="flex: 1;">
                            <span id="quantityUnit" style="align-self: center; color: #666;">г</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Резервации на месяц</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupReservationType" style="flex: 0 0 80px;">
                                <option value="weight">Вес</option>
                                <option value="pieces">Ед.</option>
                            </select>
                            <input type="number" id="groupReservation" placeholder="100" style="flex: 1;">
                            <span id="reservationUnit" style="align-self: center; color: #666;">г</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="createProductGroup()">Создать группу</button>
                    <button class="btn btn-secondary" onclick="clearGroupForm()">Очистить форму</button>
                </div>
            </div>

            <!-- Список групп товаров -->
            <div class="warehouse-section" style="margin-top: 30px;">
                <h3>Группы товаров</h3>
                <div id="productGroupsList">
                    <!-- Здесь будут отображаться группы товаров -->
                </div>
            </div>
        </div>

        <!-- Создать инвойс -->
        <div id="invoice" class="tab-content">
            <h2>Создать инвойс</h2>
            
            <div class="company-info">
                <h3>Поставщик</h3>
                <p><strong>Среħа 2024 ДОО Београд (Стари Град)</strong></p>
                <p>Матични број: 22019309 | ПИБ: 114407658</p>
                <p>Седиште: Београд, Стари Град, Мајке Јевросиме 35</p>
                <p>Рачун: 190-0000000085540-29 (Alta Banka)</p>
            </div>

            <div class="section-card">
                <h3>Основные данные</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Номер инвойса *</label>
                        <input type="text" id="invoiceNumber" placeholder="1-DDMMYYYY">
                    </div>
                    <div class="form-group">
                        <label>Дата *</label>
                        <input type="date" id="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label>Срок оплаты *</label>
                        <input type="date" id="invoiceDueDate">
                    </div>
                    <div class="form-group">
                        <label>Клиент *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="invoiceClientSearch" placeholder="Введите название клиента..." autocomplete="off">
                            <input type="hidden" id="invoiceClient" value="">
                            <div class="dropdown-menu" id="invoiceClientDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Способ доставки</label>
                        <select id="invoiceDelivery">
                            <option value="сопствени превоз">Сопствени превоз</option>
                            <option value="курирска служба">Курирская служба</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>НДС (%)</label>
                        <select id="invoiceVAT">
                            <option value="0">0%</option>
                            <option value="20">20%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="differentDeliveryAddress" style="width: auto;">
                            Адрес доставки отличается от адреса седишта
                        </label>
                    </div>
                </div>
            </div>

            <!-- Адрес доставки -->
            <div id="deliveryAddressSection" class="section-card" style="display: none;">
                <h3>Адрес доставки</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Город *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryCity" placeholder="Введите название города..." autocomplete="off">
                            <div class="dropdown-menu" id="deliveryCityDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Община *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryMunicipality" placeholder="Выберите сначала город..." autocomplete="off" disabled>
                            <div class="dropdown-menu" id="deliveryMunicipalityDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Улица *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryStreet" placeholder="Выберите сначала общину..." autocomplete="off" disabled>
                            <div class="dropdown-menu" id="deliveryStreetDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Номер дома</label>
                        <input type="text" id="deliveryHouseNumber" placeholder="Номер дома">
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>Товары</h3>
                <div id="invoiceItems">
                    <div class="invoice-items">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Товар *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                                <input type="hidden" class="invoice-product" value="">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Количество</label>
                            <input type="number" class="invoice-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Цена (RSD)</label>
                            <input type="number" class="invoice-price" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Сумма (RSD)</label>
                            <input type="number" class="invoice-amount" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addInvoiceItem()">Добавить товар</button>
                
                <div class="totals">
                    <div class="totals-row">
                        <span>Подтотал:</span>
                        <span id="invoiceSubtotal">0.00 RSD</span>
                    </div>
                    <div class="totals-row">
                        <span>НДС:</span>
                        <span id="invoiceVATAmount">0.00 RSD</span>
                    </div>
                    <div class="totals-final">
                        <span>ИТОГО:</span>
                        <span id="invoiceTotal">0.00 RSD</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="generateInvoice()">Сгенерировать инвойс</button>
                <button class="btn btn-success" onclick="confirmInvoice()">Утвердить инвойс</button>
                <button class="btn btn-secondary" onclick="generateDeliveryFromInvoice()">Создать отпремницу</button>
            </div>
            
            <div id="invoicePreview" class="preview" style="display: none;">
                <h3>Предпросмотр инвойса</h3>
                <div id="invoiceContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="exportInvoiceToPDF()">Экспорт PDF</button>
                    <button class="btn btn-secondary" onclick="downloadInvoiceAsHTML()">Скачать HTML</button>
                    <button class="btn btn-secondary" onclick="copyInvoiceToClipboard()">Копировать</button>
                </div>
                <div id="invoiceConfirmMessage" style="display: none; margin-top: 15px;" class="alert alert-success">
                    Инвойс утвержден и добавлен в статистику продаж!
                </div>
            </div>
        </div>

        <!-- Создать отпремницу -->
        <div id="delivery" class="tab-content">
            <h2>Создать отпремницу</h2>
            
            <div class="company-info">
                <h3>Отправитель</h3>
                <p><strong>Среħа 2024 ДОО Београд (Стари Град)</strong></p>
                <p>Матични број: 22019309 | ПИБ: 114407658</p>
                <p>Седиште: Београд, Стари Град, Мајке Јевросиме 35</p>
            </div>

            <div class="section-card">
                <h3>Основные данные</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Номер отпремницы *</label>
                        <input type="text" id="deliveryNumber" placeholder="1-DDMMYYYY">
                    </div>
                    <div class="form-group">
                        <label>Дата *</label>
                        <input type="date" id="deliveryDate">
                    </div>
                    <div class="form-group">
                        <label>Срок поставки *</label>
                        <input type="date" id="deliveryDueDate">
                    </div>
                    <div class="form-group">
                        <label>Получатель *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryClientSearch" placeholder="Введите название получателя..." autocomplete="off">
                            <input type="hidden" id="deliveryClient" value="">
                            <div class="dropdown-menu" id="deliveryClientDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Способ доставки</label>
                        <select id="deliveryMethod">
                            <option value="сопствени превоз">Сопствени превоз</option>
                            <option value="курирска служба">Курирская служба</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>Товары</h3>
                <div id="deliveryItems">
                    <div class="delivery-items">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Товар *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input delivery-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                                <input type="hidden" class="delivery-product" value="">
                                <div class="dropdown-menu delivery-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Количество</label>
                            <input type="number" class="delivery-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Единица</label>
                            <input type="text" class="delivery-unit" value="ком" readonly>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeDeliveryItem(this)">Удалить</button>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addDeliveryItem()">Добавить товар</button>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="generateDelivery()">Сгенерировать отпремницу</button>
                <button class="btn btn-success" onclick="confirmDelivery()">Утвердить отпремницу</button>
            </div>
            
            <div id="deliveryPreview" class="preview" style="display: none;">
                <h3>Предпросмотр отпремницы</h3>
                <div id="deliveryContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="printDelivery()">Экспорт PDF</button>
                </div>
            </div>

            <div class="invoice-list" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Утвержденные отпремницы</h3>
                    <div class="form-group" style="margin: 0; width: 300px;">
                        <select id="deliveryClientFilter" style="margin: 0;" onchange="filterDeliveriesByClient()">
                            <option value="">Все клиенты</option>
                        </select>
                    </div>
                </div>
                <div id="confirmedDeliveriesList">
                    <p style="text-align: center; color: #666;">Нет утвержденных отпремниц</p>
                </div>
            </div>
        </div>

        <!-- Статистика продаж -->
        <div id="statistics" class="tab-content">
            <h2>Статистика продаж</h2>
            <div class="filter-section">
                <h3>Фильтры</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Период с:</label>
                        <input type="date" id="statsFromDate">
                    </div>
                    <div class="form-group">
                        <label>Период по:</label>
                        <input type="date" id="statsToDate">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="updateStatistics()">Обновить</button>
                            <button class="btn btn-success" onclick="exportStatisticsToPDF()">Скачать PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0 RSD</div>
                    <div class="stat-label">Общая выручка</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalInvoices">0</div>
                    <div class="stat-label">Всего инвойсов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">Клиентов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageOrder">0 RSD</div>
                    <div class="stat-label">Средний заказ</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Выручка по месяцам</div>
                <div id="revenueChart">График выручки будет отображен здесь</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Топ товаров по продажам</div>
                <div id="productsChart">График продаж товаров будет отображен здесь</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Топ клиентов по выручке</div>
                <div id="clientsChart">График клиентов будет отображен здесь</div>
            </div>

            <div class="invoice-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Утвержденные инвойсы</h3>
                    <div class="form-group" style="margin: 0; width: 300px;">
                        <input type="text" id="invoiceSearchInput" placeholder="Поиск по номеру инвойса..." style="margin: 0;" oninput="filterInvoicesBySearch()">
                    </div>
                </div>
                <div id="confirmedInvoicesList">
                    <p style="text-align: center; color: #666;">Нет утвержденных инвойсов</p>
                </div>
            </div>
        </div>


    </div>

    <!-- Модальное окно редактирования товара -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Редактировать товар</h2>
                <button class="close" onclick="closeEditProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Код товара *</label>
                        <input type="text" id="editProductCode" placeholder="GF-B-TG210">
                    </div>
                    <div class="form-group">
                        <label>Название товара *</label>
                        <input type="text" id="editProductName" placeholder="Tieguanyin/Zeleni Čaj 210g">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Стоимость без НДС (RSD) *</label>
                        <input type="number" id="editProductPrice" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Вес (г)</label>
                        <input type="number" id="editProductWeight" placeholder="210" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Категория</label>
                    <select id="editProductCategory">
                        <option value="">Выберите категорию</option>
                        <option value="Zeleni Čaj">Зеленый чай</option>
                        <option value="Crni Čaj">Черный чай</option>
                        <option value="Printing">Полиграфия</option>
                        <option value="Other">Другое</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveProductChanges()">Сохранить изменения</button>
                <button class="btn btn-secondary" onclick="closeEditProductModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно логов -->
    <div id="logsModal" class="modal">
        <div class="modal-content" style="
            max-width: 90vw; 
            width: 800px; 
            max-height: 85vh; 
            margin: 5vh auto; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        ">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">Логи действий</h2>
                <button class="close" onclick="closeLogsModal()">&times;</button>
            </div>
            <div class="modal-body" style="
                flex: 1; 
                overflow: hidden; 
                padding: 20px; 
                display: flex; 
                flex-direction: column;
            ">
                <div id="logsContainer" style="
                    background: #f8f9fa; 
                    border-radius: 12px; 
                    padding: 20px; 
                    flex: 1; 
                    overflow-y: auto; 
                    border: 2px solid #e9ecef;
                    min-height: 200px;
                ">
                    <ul id="logsList" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
            </div>
            <div class="modal-footer" style="
                text-align: center; 
                padding: 20px; 
                border-top: 1px solid #e9ecef; 
                flex-shrink: 0;
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            ">
                <button class="btn btn-success" onclick="exportLogsToExcel()" style="min-width: 150px;">
                    <span style="font-size: 14px; margin-right: 5px;">📊</span>
                    Экспорт в Excel
                </button>
                <button class="btn btn-secondary" onclick="clearLogs()" style="min-width: 120px;">Очистить логи</button>
                <button class="btn btn-secondary" onclick="closeLogsModal()" style="min-width: 100px;">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления пользователя -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Добавить нового пользователя</h2>
                <button class="close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Логин:</label>
                    <input type="text" id="newUserLogin" placeholder="Введите логин" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Пароль:</label>
                    <input type="password" id="newUserPassword" placeholder="Введите пароль" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label>Подтвердите пароль:</label>
                    <input type="password" id="confirmUserPassword" placeholder="Повторите пароль" autocomplete="new-password">
                </div>
                <div id="addUserError" class="login-error" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="addNewUser()">Добавить пользователя</button>
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования пользователей -->
    <div id="editUsersModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Управление пользователями</h2>
                <button class="close" onclick="closeEditUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Список пользователей будет добавлен динамически -->
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeEditUsersModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно управления доступом -->
    <div id="userPermissionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="permissionsTitle">Управление доступом</h2>
                <button class="close" onclick="closeUserPermissionsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h4>Доступ к вкладкам:</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_clients" style="transform: scale(1.2);">
                            <span>Клиенты</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_products" style="transform: scale(1.2);">
                            <span>Товары</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_warehouse" style="transform: scale(1.2);">
                            <span>Склад</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_invoice" style="transform: scale(1.2);">
                            <span>Инвойс</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_delivery" style="transform: scale(1.2);">
                            <span>Отпремница</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_statistics" style="transform: scale(1.2);">
                            <span>Статистика</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_logs" style="transform: scale(1.2);">
                            <span>Логи</span>
                        </label>
                        <hr style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; gap: 10px;" id="editUserPermLabel">
                            <input type="checkbox" id="perm_editUsers" style="transform: scale(1.2);">
                            <span>Редактировать пользователя</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="saveUserPermissions()">Сохранить</button>
                <button class="btn btn-secondary" onclick="closeUserPermissionsModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно истории клиента -->
    <div id="clientHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="clientHistoryTitle">История инвойсов клиента</h2>
                <button class="close" onclick="closeClientHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="clientHistoryContent" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">Загрузка...</p>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeClientHistoryModal()">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно профиля клиента -->
    <div id="clientProfileModal" class="modal">
        <div class="modal-content client-profile-modal">
            <!-- Заголовок карточки -->
            <div class="client-card-header">
                <div class="client-avatar" id="clientAvatar">КЛ</div>
                <div class="client-title-info">
                    <h2 id="clientProfileTitle">Профиль клиента</h2>
                    <p id="clientProfileSubtitle">Основные данные и статистика</p>
                </div>
                <button class="close" onclick="closeClientProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            </div>

            <!-- Секции профиля (режим просмотра) -->
            <div id="profile-sections" class="profile-sections">
                <!-- Основная информация -->
                <div class="profile-section">
                    <h3>📋 Основная информация</h3>
                    <div class="profile-field">
                        <span class="profile-field-label">Название:</span>
                        <span class="profile-field-value" id="profileClientName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Юридическое:</span>
                        <span class="profile-field-value" id="profileClientLegalName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">МБ:</span>
                        <span class="profile-field-value" id="profileClientMB">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">ПИБ:</span>
                        <span class="profile-field-value" id="profileClientPIB">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Контакт. лицо:</span>
                        <span class="profile-field-value" id="profileClientContactPerson">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Банк:</span>
                        <span class="profile-field-value" id="profileClientBank">-</span>
                    </div>
                </div>

                <!-- Адрес -->
                <div class="profile-section">
                    <h3>📍 Адрес</h3>
                    <div class="profile-address">
                        <span class="address-text" id="profileClientAddress">-</span>
                        <button id="profileGoogleMapsBtn" class="maps-btn" style="display: none;" onclick="openGoogleMaps()" title="Открыть в Google Maps">🗺️</button>
                    </div>
                </div>

                <!-- Контактные данные -->
                <div class="profile-section">
                    <h3>📞 Контактные данные</h3>
                    <div class="contact-grid">
                        <div class="contact-item" id="contactPhone" style="display: none;">
                            <div class="contact-icon phone">📞</div>
                            <div class="contact-value" id="profileClientPhone">-</div>
                        </div>
                        <div class="contact-item" id="contactEmail" style="display: none;">
                            <div class="contact-icon email">✉️</div>
                            <div class="contact-value" id="profileClientEmail">-</div>
                        </div>
                        <div class="contact-item" id="contactTelegram" style="display: none;">
                            <div class="contact-icon telegram">✈️</div>
                            <div class="contact-value" id="profileClientTelegram">-</div>
                        </div>
                        <div class="contact-item" id="contactInstagram" style="display: none;">
                            <div class="contact-icon instagram">📷</div>
                            <div class="contact-value" id="profileClientInstagram">-</div>
                        </div>
                    </div>
                </div>

                <!-- Условия сотрудничества -->
                <div class="profile-section">
                    <h3>🤝 Условия сотрудничества</h3>
                    <div class="collaboration-tags" id="collaborationTags">
                        <!-- Теги будут добавлены динамически -->
                    </div>
                    <div class="profile-notes" id="profileClientNotes" style="display: none;">
                        <!-- Примечания -->
                    </div>
                </div>

                <!-- Статистика -->
                <div class="profile-section" style="grid-column: 1 / -1;">
                    <h3>📊 Статистика клиента</h3>
                    <div class="period-selector">
                        <label>Период:</label>
                        <select id="statisticsPeriod" onchange="updateClientStatistics()">
                            <option value="all">Всё время</option>
                            <option value="year">Текущий год</option>
                            <option value="quarter">Текущий квартал</option>
                            <option value="month">Текущий месяц</option>
                        </select>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="clientAvgOrderValue">0 RSD</div>
                            <div class="stat-label">Средняя сумма заказа</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientInvoiceCount">0</div>
                            <div class="stat-label">Количество инвойсов</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientTopProduct">-</div>
                            <div class="stat-label">Популярный продукт</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientYearlyConsumption">0 RSD</div>
                            <div class="stat-label">Потребление в год</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Форма редактирования (режим редактирования) -->
            <div id="edit-sections" class="profile-sections" style="display: none;">
                <div class="client-form-grid">
                    <!-- Основная информация -->
                    <div class="form-section">
                        <h4>📋 Основная информация</h4>
                        <div class="form-group">
                            <label>Название компании *</label>
                            <input type="text" id="editClientName" placeholder="Название компании">
                        </div>
                        <div class="form-group">
                            <label>Юридическое название *</label>
                            <input type="text" id="editClientLegalName" placeholder="Полное юридическое название">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Матични број *</label>
                                <input type="text" id="editClientMB" placeholder="Матични број">
                            </div>
                            <div class="form-group">
                                <label>ПИБ *</label>
                                <input type="text" id="editClientPIB" placeholder="ПИБ">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Контактное лицо</label>
                                <input type="text" id="editClientContactPerson" placeholder="Имя контактного лица">
                            </div>
                            <div class="form-group">
                                <label>Банковский счет</label>
                                <input type="text" id="editClientBank" placeholder="Номер банковского счета">
                            </div>
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="form-section">
                        <h4>📍 Адрес</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editManualAddressInput" style="width: auto;">
                                Ручной ввод адреса
                            </label>
                        </div>
                        
                        <!-- Автоматический ввод адреса -->
                        <div id="editAutoAddressSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Город *</label>
                                    <input type="text" id="editClientCity" placeholder="Город">
                                </div>
                                <div class="form-group">
                                    <label>Община *</label>
                                    <input type="text" id="editClientMunicipality" placeholder="Община">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Улица *</label>
                                    <input type="text" id="editClientStreet" placeholder="Улица">
                                </div>
                                <div class="form-group">
                                    <label>Номер дома</label>
                                    <input type="text" id="editClientHouseNumber" placeholder="Номер дома">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ручной ввод адреса -->
                        <div id="editManualAddressSection" style="display: none;">
                            <div class="form-group">
                                <label>Полный адрес *</label>
                                <textarea id="editClientManualAddress" placeholder="Введите полный адрес" rows="3" style="resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ссылка на Google Maps</label>
                            <input type="text" id="editClientGoogleMaps" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <!-- Контактные данные -->
                    <div class="form-section">
                        <h4>📞 Контактные данные</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Телефон</label>
                                <input type="text" id="editClientPhone" placeholder="+381 XX XXX XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editClientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram</label>
                                <input type="text" id="editClientTelegram" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="editClientInstagram" placeholder="@username">
                            </div>
                        </div>
                    </div>

                    <!-- Условия сотрудничества -->
                    <div class="form-section">
                        <h4>🤝 Условия сотрудничества</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editClientInstallment" style="transform: scale(1.2);">
                                    <span>Рассрочка оплаты</span>
                                </label>
                                <input type="text" id="editClientInstallmentTerm" placeholder="Срок (дни)" style="margin-top: 5px;">
                            </div>
                            <div class="form-group">
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editClientShowcase" style="transform: scale(1.2);">
                                        <span>Витрина</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editClientBar" style="transform: scale(1.2);">
                                        <span>Бар</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Примечания</label>
                            <textarea id="editClientNotes" placeholder="Дополнительные примечания о клиенте" rows="3" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопки режима просмотра -->
            <div id="viewModeFooter" class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef;">
                <button class="btn btn-primary" onclick="switchToEditMode()" style="margin-right: 10px;">✏️ Редактировать</button>
                <button class="btn btn-primary" onclick="switchToClientHistory()" style="margin-right: 10px;">📋 История заказов</button>
                <button class="btn btn-secondary" onclick="closeClientProfileModal()">❌ Закрыть</button>
            </div>

            <!-- Кнопки режима редактирования -->
            <div id="editModeFooter" class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef; display: none;">
                <button class="btn btn-primary" onclick="saveClientChanges()" style="margin-right: 10px;">✅ Сохранить изменения</button>
                <button class="btn btn-secondary" onclick="switchToViewMode()" style="margin-right: 10px;">❌ Отмена</button>
            </div>

            <!-- История заказов -->
            <div id="clientHistorySection" style="display: none;">
                <div class="client-card-header">
                    <div class="client-avatar" id="historyClientAvatar">КЛ</div>
                    <div class="client-title-info">
                        <h2 id="historyClientTitle">История заказов</h2>
                        <p id="historyClientSubtitle">Инвойсы и отпремницы клиента</p>
                    </div>
                    <button class="close" onclick="closeClientProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
                </div>
                
                <div style="padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="switchToClientProfile()">← Обратно к профилю</button>
                        <button class="btn btn-primary" onclick="exportClientHistoryToPDF()">📄 Экспорт в PDF</button>
                    </div>
                    
                    <!-- Вкладки истории -->
                    <div class="history-tabs" style="margin-bottom: 20px;">
                        <button class="history-tab active" onclick="switchHistoryTab('invoices')" id="invoicesTab">
                            📋 Инвойсы (<span id="invoicesCount">0</span>)
                        </button>
                        <button class="history-tab" onclick="switchHistoryTab('deliveries')" id="deliveriesTab">
                            📦 Отпремницы (<span id="deliveriesCount">0</span>)
                        </button>
                    </div>
                    
                    <!-- Контент инвойсов -->
                    <div id="clientInvoicesContent" style="max-height: 60vh; overflow-y: auto;">
                        <p style="text-align: center; color: #666;">Загрузка...</p>
                    </div>
                    
                    <!-- Контент отпремниц -->
                    <div id="clientDeliveriesContent" style="max-height: 60vh; overflow-y: auto; display: none;">
                        <p style="text-align: center; color: #666;">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        let clients = [], products = [], confirmedInvoices = [], confirmedDeliveries = [], currentInvoiceData = null;

        // Полный список всех общин Сербии (независимо от города)
        const allMunicipalities = [
            // Београд - градске општине
            "Barajevo", "Voždovac", "Vračar", "Grocka", "Zvezdara", "Zemun", "Lazarevac", 
            "Mladenovac", "Novi Beograd", "Obrenovac", "Palilula", "Rakovica", "Savski venac", 
            "Sopot", "Stari grad", "Surčin", "Čukarica",
            
            // Градови
            "Novi Sad", "Niš", "Kragujevac", "Subotica", "Pančevo", "Čačak", "Novi Pazar", 
            "Zrenjanin", "Leskovac", "Bor", "Valjevo", "Vranje", "Vršac", "Zaječar", 
            "Jagodina", "Kikinda", "Kraljevo", "Kruševac", "Loznica", "Pirot", "Požarevac", 
            "Priština", "Prokuplje", "Smederevo", "Sombor", "Sremska Mitrovica", "Užice", "Šabac",
            
            // Медијана, Палилула (Ниш)
            "Medijana", "Pantelej", "Crveni Krst", "Niška Banja",
            
            // Врање
            "Vranje grad", "Vranje selo",
            
            // Пожаревац
            "Požarevac grad", "Kostolac",
            
            // Ужице
            "Užice grad", "Sevojno",
            
            // Општине
            "Aleksandrovac", "Aleksinac", "Aranđelovac", "Arilje", "Babušnica", "Bač", 
            "Bačka Palanka", "Bačka Topola", "Bačko Gradište", "Bajina Bašta", "Bela Crkva", 
            "Bela Palanka", "Beočin", "Blace", "Bogatić", "Bojnik", "Boljevac", "Bosilegrad", 
            "Brus", "Bujanovac", "Čajetina", "Čoka", "Ćićevac", "Ćuprija", "Despotovac", 
            "Dimitrovgrad", "Doljevac", "Gadžin Han", "Golubac", "Gornji Milanovac", "Ivanjica", 
            "Irig", "Kanjiža", "Kladovo", "Knjaževac", "Knić", "Koceljeva", "Kosjerić", "Kovin", 
            "Krupanj", "Kučevo", "Kuršumlija", "Lajkovac", "Lapovo", "Lebane", "Ljig", "Ljubovija", 
            "Lučani", "Majdanpek", "Malo Crniće", "Medveđa", "Merošina", "Mionica", "Negotin", 
            "Nova Crnja", "Nova Varoš", "Novi Bečej", "Novi Kneževac", "Odžaci", "Opovo", 
            "Osečina", "Paraćin", "Pećinci", "Petrovac na Mlavi", "Plandište", "Požega", 
            "Preševo", "Priboj", "Prijepolje", "Rača", "Raška", "Ražanj", "Rekovac", "Ruma", 
            "Sečanj", "Senta", "Šid", "Sjenica", "Sokobanja", "Srbobran", "Sremski Karlovci", 
            "Stara Pazova", "Surdulica", "Svilajnac", "Temerin", "Titel", "Topola", "Trstenik", 
            "Tutin", "Ub", "Varvarin", "Velika Plana", "Vladičin Han", "Vladimirci", "Vlasotince", 
            "Vojnik", "Vrbas", "Vrnjačka Banja", "Žabalj", "Žabari", "Žagubica", "Žitište", "Žitorađa",
            
            // Бачки Петровац
            "Bački Petrovac", "Kulpin", "Maglić", "Gložan",
            
            // Ада
            "Ada", "Mol", "Obornjača",
            
            // Алибунар
            "Alibunar", "Banatski Karlovci", "Vladimirovac",
            
            // Апатин
            "Apatin", "Prigrevica", "Kupusina",
            
            // Инђија
            "Inđija", "Beška", "Ljukovo", "Maradik",
            
            // Мали Иђош
            "Mali Iđoš", "Lovćenac", "Feketić"
        ];

        // Основные улицы (общий список для всех общин)
        const commonStreets = [
            "Главна", "Карађорђева", "Краља Петра", "Светог Саве", "Немањина", 
            "Кнеза Милоша", "Железничка", "Партизанска", "Омладинска", "Школска",
            "Трг ослобођења", "Bulevar oslobođenja", "Дунавска", "Моравска", 
            "Првомајска", "Николе Пашића", "Светозара Марковића", "Димитрија Туцовића",
            "Јована Јовановића Змаја", "Вука Караџића", "Доситејева", "Браће Југовића",
            "Кнез Михаилова", "Теразије", "Студентски трг", "Скадарска", "Душанова",
            "Масарикова", "Милетићева", "Фрушкогорска", "Банатска", "Војвођанска",
            "Сремска", "Бачка", "Златиборска", "Копаоничка", "Рудничка", "Шумадијска",
            "Poštanska", "Maksima Gorkog", "Majke Jevrosime", "Kneza Višeslava",
            "Bulevar kralja Aleksandra", "Bulevar Nemanjića", "Bulevar despota Stefana"
        ];

        // Полный список городов и общин Сербии
        const addressData = {
            cities: {
                // ГРАДОВИ (28 + Београд)
                "Beograd": {
                    municipalities: ["Barajevo", "Voždovac", "Vračar", "Grocka", "Zvezdara", "Zemun", "Lazarevac", "Mladenovac", "Novi Beograd", "Obrenovac", "Palilula", "Rakovica", "Savski venac", "Sopot", "Stari grad", "Surčin", "Čukarica"],
                    streets: {
                        "Stari grad": ["Studentski trg", "Knez Mihailova", "Terazije", "Kralja Petra", "Vasa Čarapića", "Makedonska", "Zeleni venac", "Dušanova", "Skadarska", "Kosančićev venac", "Cara Dušana", "Kralja Milana", "Nemanjina", "Resavska", "Balkanska", "Vasina", "Francuska", "Užička", "Pop Lukina", "Dobračina", "Jevremova", "Gospodar Jevremova", "Admirala Geprata", "Gavrila Principa", "Pariska", "Strahinjića Bana", "Rajićeva", "Tadeuša Košćuška", "Čika Ljubina", "Bulevar despota Stefana", "Hilandarska", "Simina", "Braće Jugovića", "Svetogorska", "Dzordza Vašingtona", "Višegradska", "Prizrenska", "Cara Nikolaja II", "Zmaj Jovina", "Braće Baruh", "Kolarčeva", "Venizelosova", "Majke Jevrosime", "Čumićeva", "Dimitrija Tucovića", "Dunavska", "Obilicev venac", "Strahinića Bana"],
                        "Novi Beograd": ["Bulevar Zorana Đinđića", "Bulevar Mihajla Pupina", "Jurija Gagarina", "Gandijeva", "Milentija Popovića", "Antifašističke borbe", "Bulevar Arsenija Čarnojevića", "Dr Ivana Ribara", "Omladinskih brigada", "Narodnih heroja", "Tošin bunar", "Bulevar Nikole Tesle", "Vladimira Popovića", "Đorđa Stanojevića", "Nehruova", "Save Kovačevića", "Kornelija Stankovića", "Partizanske avijacije"],
                        "Voždovac": ["Bulevar oslobođenja", "Ustanička", "Veljka Dugoševića", "Autoput za Niš", "Kumodraška", "Crnotravska", "Trešnjinog cveta", "Patrijarha Dimitrija", "Južni bulevar", "Medakovićeva", "Braće Jerković", "Vojvode Stepe", "Humska", "Banjička"],
                        "Vračar": ["Bulevar kralja Aleksandra", "Krunska", "Kneginje Zorke", "Svetosavska", "Njegoševa", "Čarlija Čaplina", "Maksima Gorkog", "Karađorđeva", "Beogradska", "Neimarska", "Despota Stefana", "Katanićeva", "Kralja Milana", "Dečanska"],
                        "Zvezdara": ["Bulevar kralja Aleksandra", "Dimitrija Tucovića", "Milana Rakića", "Cvijićeva", "Veljka Vlahovića", "Dragoslava Srejovića", "Alekse Nenadovića", "Ruzveltova", "Učiteljska", "Bulevar Mihajla Pupina", "Djure Jakšića"],
                        "Zemun": ["Glavna", "Cara Dušana", "Zemunski kej", "Magistratski trg", "Karamatina", "Dubrovačka", "Gorkoga", "Tošin bunar", "Batajnički drum", "Ugrinovačka", "Bečkerečka", "Prvomajska"],
                        "Čukarica": ["Požeška", "Patrijarha Dimitrija", "Kneza Višeslava", "Ibarska magistrala", "Radnička", "Banovo brdo", "Čukarička", "Banjica", "Sremčica", "Železnička"],
                        "Palilula": ["Dunavska", "Francuska", "Visokog Stevana", "Učiteljska", "Dalmatinska", "Cara Nikolaja II", "Bulevar despota Stefana", "Ruzveltova", "Višnjićeva", "Tadeuša Košćuška"],
                        "Savski venac": ["Nemanjina", "Karađorđeva", "Bulevar vojvode Mišića", "Kneza Miloša", "Sarajevska", "Hajduk Veljkova", "Gavrila Principa", "Resavska", "Prizrenska", "Svetog Save"],
                        "Rakovica": ["Borska", "Patrijarha Dimitrija", "Rakovička", "Ibarska magistrala", "Kneza Višeslava", "Trgovačka", "Miloša Obrenović", "Crnotravska"],
                        "Grocka": ["Smederevski put", "Boljevačka", "Grocka", "Pukovnika Milenka Pavlovića", "Vinička", "Boleč", "Begaljica"],
                        "Lazarevac": ["Kralja Petra", "Svetog Save", "Trg oslobođenja", "Nemanjina", "Bulevar oslobođenja", "Ibarska magistrala", "Stevan Mokranjac"],
                        "Mladenovac": ["Kralja Aleksandra", "Svetog Save", "Nemanjina", "Trg oslobođenja", "Karađorđeva", "Kosmajska", "Jagodinska"],
                        "Obrenovac": ["Kralja Petra", "Miloša Obrenovića", "Vuka Karadžića", "Cara Lazara", "Trg oslobođenja", "Obilićeva", "Zmaj Jovina"],
                        "Sopot": ["Sopot", "Kosmajska", "Nemenikuće", "Dučina", "Parcani", "Rogača"],
                        "Surčin": ["Surčin", "Bečkerečka", "Dobanovci", "Petrovčić", "Boljevci", "Jakovo"],
                        "Barajevo": ["Barajevo", "Arnajevo", "Boždarevac", "Guncati", "Manić", "Šiljakovac"]
                    }
                },
                "Novi Sad": {
                    municipalities: ["Novi Sad"],
                    streets: {
                        "Novi Sad": ["Bulevar oslobođenja", "Zmaj Jovina", "Dunavska", "Kralja Aleksandra", "Miletićeva", "Futoška", "Bulevar cara Lazara", "Narodnog fronta", "Straže Novosadske", "Jevrejska", "Katolička porta", "Grčka", "Masarikova", "Jovana Đorđevića", "Modene", "Ilije Ognjanovića", "Svetozara Miletića", "Vladimira Nazora", "Kisačka", "Bulevar Evrope"]
                    }
                },
                "Niš": {
                    municipalities: ["Medijana", "Palilula", "Pantelej", "Crveni Krst", "Niška Banja"],
                    streets: {
                        "Medijana": ["Bulevar Nemanjića", "Obrenovićeva", "Vozda Karađorđa", "Dr Zoran Đinđić", "Bulevar 12. februar", "Dušanova", "Kneginje Ljubice"],
                        "Palilula": ["Cara Dušana", "Bulevar Evrope", "Jaše Prodanovića", "Stevana Mokranjca", "Vojvode Tankosića", "Hadži Milentijeva"],
                        "Pantelej": ["Bulevar Nemanjića", "Partizanska", "Ćirila i Metodija", "Stevana Sremca", "Kneginje Milice"],
                        "Crveni Krst": ["Bulevar Evrope", "Partizanska", "Vojvode Tankosića", "Stevana Mokranjca"],
                        "Niška Banja": ["Sinđelićeva", "Dr Milutina Ivkovića", "Železnička", "Knjeginje Milice"]
                    }
                },
                "Kragujevac": {
                    municipalities: ["Kragujevac"],
                    streets: {
                        "Kragujevac": ["Kralja Aleksandra", "Svetozara Markovića", "Dositejeva", "Bulevar kraljice Marije", "Jovana Cvijića", "Kneza Mihaila", "Nikole Pašića", "Cara Lazara", "Đure Đakovića", "Kralja Petra"]
                    }
                },
                "Subotica": {
                    municipalities: ["Subotica"],
                    streets: {
                        "Subotica": ["Trg slobode", "Korzo", "Matice srpske", "Segedinski put", "Cara Lazara", "Maksima Gorkog", "Đure Đakovića", "Raše Končara", "Somborska", "Banatska"]
                    }
                },
                "Pančevo": {
                    municipalities: ["Pančevo"],
                    streets: {
                        "Pančevo": ["Trg kralja Petra", "Železnička", "Svetog Save", "Cara Lazara", "Dimitrija Tucovića", "Vojvodine", "Miloša Trebinjca", "Braće Jovanović", "Đure Đakovića"]
                    }
                },
                "Čačak": {
                    municipalities: ["Čačak"],
                    streets: {
                        "Čačak": ["Bulevar oslobodilaca", "Kneza Mihaila", "Žička", "Cara Dušana", "Svetog Save", "Nikole Pašića", "Prvomajska", "Dimitrija Tucovića"]
                    }
                },
                "Novi Pazar": {
                    municipalities: ["Novi Pazar"],
                    streets: {
                        "Novi Pazar": ["28. novembar", "Stevana Nemanje", "Rifata Burdžovića", "Alije Izetbegovića", "Generala Živkovića", "Vuka Karadžića", "Sutjeska"]
                    }
                },
                "Zrenjanin": {
                    municipalities: ["Zrenjanin"],
                    streets: {
                        "Zrenjanin": ["Trg slobode", "Kralja Aleksandra", "Đure Đakovića", "Bulevar Đorđa Vajferta", "Sečanj", "Dimitrija Tucovića", "Maksima Gorkog"]
                    }
                },
                "Leskovac": {
                    municipalities: ["Leskovac"],
                    streets: {
                        "Leskovac": ["Bulevar oslobođenja", "Stevana Mokranjca", "Cara Dušana", "Nikole Pašića", "Bulevar heroes", "Žitni trg", "Svetozara Markovića"]
                    }
                },
                "Bor": {
                    municipalities: ["Bor"],
                    streets: {
                        "Bor": ["Moše Pijade", "7. jula", "Đorđa Vajferta", "Trg oslobođenja", "Kralja Petra"]
                    }
                },
                "Valjevo": {
                    municipalities: ["Valjevo"],
                    streets: {
                        "Valjevo": ["Karađorđeva", "Vladike Nikolaja", "Birčaninova", "Vojvode Mišića", "Kneza Miloša"]
                    }
                },
                "Vranje": {
                    municipalities: ["Vranje grad", "Vranje selo"],
                    streets: {
                        "Vranje grad": ["Kralja Stefana Prvovenčanog", "Svetozara Markovića", "Prvomajska", "Kralja Aleksandra", "Titova"],
                        "Vranje selo": ["Seoska ulica", "Glavna", "Centralna"]
                    }
                },
                "Vršac": {
                    municipalities: ["Vršac"],
                    streets: {
                        "Vršac": ["Svetosavska", "Trg pobede", "Heroja Pinkija", "Abrahama Linkolna", "Vojvođanska"]
                    }
                },
                "Zaječar": {
                    municipalities: ["Zaječar"],
                    streets: {
                        "Zaječar": ["Kralja Aleksandra", "Svetozara Markovića", "Hajduk Veljkova", "Nikole Pašića", "Kneginje Ljubice"]
                    }
                },
                "Jagodina": {
                    municipalities: ["Jagodina"],
                    streets: {
                        "Jagodina": ["Kneginje Milice", "Svetozara Markovića", "Karadjordjeva", "Kralja Petra", "Nikole Pašića"]
                    }
                },
                "Kikinda": {
                    municipalities: ["Kikinda"],
                    streets: {
                        "Kikinda": ["Trg srpskih dobrovoljaca", "Svetosavska", "Gospodara Vučića", "Sečeranska", "Žarka Zrenjanina"]
                    }
                },
                "Kraljevo": {
                    municipalities: ["Kraljevo"],
                    streets: {
                        "Kraljevo": ["Kraljice Marije", "Karađorđeva", "Omladinska", "Trg srpskih ratnika", "Nemanjina"]
                    }
                },
                "Kruševac": {
                    municipalities: ["Kruševac"],
                    streets: {
                        "Kruševac": ["Kneza Miloša", "Gazimestanska", "Vidovdanska", "Ćele kule", "Majke Jugovića"]
                    }
                },
                "Loznica": {
                    municipalities: ["Loznica"],
                    streets: {
                        "Loznica": ["Kneza Miloša", "Karađorđeva", "Vuka Karadžića", "Pasićeva", "Jovan Cvijić"]
                    }
                },
                "Pirot": {
                    municipalities: ["Pirot"],
                    streets: {
                        "Pirot": ["Srpskih vladara", "Kralja Petra", "Nikole Pašića", "Trg pobede", "Beogradska"]
                    }
                },
                "Požarevac": {
                    municipalities: ["Požarevac grad", "Kostolac"],
                    streets: {
                        "Požarevac grad": ["Dunavska", "Karađorđeva", "Svetozara Markovića", "Kneza Miloša", "Drinčićeva"],
                        "Kostolac": ["Glavna", "Termoelektrane", "Rudarska", "Drinčićeva"]
                    }
                },
                "Priština": {
                    municipalities: ["Priština"],
                    streets: {
                        "Priština": ["Kralja Petra", "Lole Ribara", "Omladinska", "Dečanska", "Vidovdanska"]
                    }
                },
                "Prokuplje": {
                    municipalities: ["Prokuplje"],
                    streets: {
                        "Prokuplje": ["Topličina", "Karađorđeva", "Vojvode Stepe", "Svetog Save", "Nikole Pašića"]
                    }
                },
                "Smederevo": {
                    municipalities: ["Smederevo"],
                    streets: {
                        "Smederevo": ["Kralja Petra", "Dunavska", "Omladinska", "Đuriška", "Svetog Đorđa"]
                    }
                },
                "Sombor": {
                    municipalities: ["Sombor"],
                    streets: {
                        "Sombor": ["Trg cara Uroša", "Апатински пут", "Венац војводе Степе", "Војводе Путника", "Кнеза Михаила"]
                    }
                },
                "Sremska Mitrovica": {
                    municipalities: ["Sremska Mitrovica"],
                    streets: {
                        "Sremska Mitrovica": ["Светог Димитрија", "Краља Петра", "Железничка", "Фрушкогорска", "Војвођанска"]
                    }
                },
                "Užice": {
                    municipalities: ["Užice grad", "Sevojno"],
                    streets: {
                        "Užice grad": ["Партизанска", "Димитрија Туцовића", "Милоша Обилића", "Трг партизана", "Немањина"],
                        "Sevojno": ["Златиборска", "Милана Ракића", "Светог Саве", "Железничка"]
                    }
                },
                "Šabac": {
                    municipalities: ["Šabac"],
                    streets: {
                        "Šabac": ["Карађорђева", "Масарикова", "Хајдук Вељкова", "Трг ослобођења", "Војводе Мишића"]
                    }
                },
                // ВЕЋИ ОПШТИНСКИ ЦЕНТРИ
                "Aleksandrovac": {
                    municipalities: ["Aleksandrovac"],
                    streets: {
                        "Aleksandrovac": ["Карађорђева", "Главна", "Жупска", "Немањина", "Топличка"]
                    }
                },
                "Aleksinac": {
                    municipalities: ["Aleksinac"],
                    streets: {
                        "Aleksinac": ["Карађорђева", "Моравска", "Краљевска", "Немањина", "Светог Саве"]
                    }
                },
                "Aranđelovac": {
                    municipalities: ["Aranđelovac"],
                    streets: {
                        "Aranđelovac": ["Карађорђева", "Краља Петра", "Бањска", "Кнеза Милоша", "Омладинска"]
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            setCurrentDate();
            generateDocumentNumbers();
            initializeStatistics();
            updateSelectOptions();
            initializeAddressSearch();
            
            // Инициализация складских данных
            renderProductGroups();
            
            // Инициализация чекбокса адреса доставки
            document.getElementById('differentDeliveryAddress').addEventListener('change', function() {
                const section = document.getElementById('deliveryAddressSection');
                if (this.checked) {
                    section.style.display = 'block';
                    initializeDeliveryAddressSearch();
                } else {
                    section.style.display = 'none';
                }
            });
            
            // Инициализация чекбокса ручного ввода адреса
            document.getElementById('manualAddressInput').addEventListener('change', function() {
                const automaticSection = document.getElementById('automaticAddressSection');
                const manualSection = document.getElementById('manualAddressSection');
                
                if (this.checked) {
                    // Переключаемся на ручной ввод
                    automaticSection.style.display = 'none';
                    manualSection.style.display = 'block';
                    
                    // Очищаем поля автоматического ввода
                    document.getElementById('clientCity').value = '';
                    document.getElementById('clientMunicipality').value = '';
                    document.getElementById('clientStreet').value = '';
                    document.getElementById('clientHouseNumber').value = '';
                } else {
                    // Переключаемся на автоматический ввод
                    automaticSection.style.display = 'block';
                    manualSection.style.display = 'none';
                    
                    // Очищаем поле ручного ввода
                    document.getElementById('clientManualAddress').value = '';
                    
                    // Сбрасываем состояние автоматических полей
                    const municipalityInput = document.getElementById('clientMunicipality');
                    const streetInput = document.getElementById('clientStreet');
                    if (municipalityInput) {
                        municipalityInput.disabled = true;
                        municipalityInput.placeholder = 'Выберите сначала город...';
                    }
                    if (streetInput) {
                        streetInput.disabled = true;
                        streetInput.placeholder = 'Выберите сначала общину...';
                    }
                }
            });

            // Закрыть модальное окно при клике вне его
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('invoiceViewModal');
                if (modal && e.target === modal) {
                    closeInvoiceViewModal();
                }
            });

            // Закрыть модальное окно при нажатии Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('invoiceViewModal');
                    if (modal) {
                        closeInvoiceViewModal();
                    }
                }
            });
        });

        function initializeAddressSearch() {
            setupCitySearch('clientCity', 'clientCityDropdown', 'clientMunicipality', 'clientMunicipalityDropdown', 'clientStreet', 'clientStreetDropdown');
        }

        function initializeDeliveryAddressSearch() {
            setupCitySearch('deliveryCity', 'deliveryCityDropdown', 'deliveryMunicipality', 'deliveryMunicipalityDropdown', 'deliveryStreet', 'deliveryStreetDropdown');
        }

        function setupCitySearch(cityInputId, cityDropdownId, municipalityInputId, municipalityDropdownId, streetInputId, streetDropdownId) {
            const cityInput = document.getElementById(cityInputId);
            const cityDropdown = document.getElementById(cityDropdownId);
            const municipalityInput = document.getElementById(municipalityInputId);
            const municipalityDropdown = document.getElementById(municipalityDropdownId);
            const streetInput = document.getElementById(streetInputId);
            const streetDropdown = document.getElementById(streetDropdownId);

            if (!cityInput || !cityDropdown) return;

            // Поиск городов
            cityInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length === 0) {
                    cityDropdown.style.display = 'none';
                    enableMunicipalityInput();
                    return;
                }

                const filteredCities = Object.keys(addressData.cities).filter(city => 
                    city.toLowerCase().includes(query)
                );

                if (filteredCities.length === 0) {
                    cityDropdown.style.display = 'none';
                    return;
                }

                cityDropdown.innerHTML = '';
                filteredCities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = city;
                    item.addEventListener('click', function() {
                        cityInput.value = city;
                        cityDropdown.style.display = 'none';
                        enableMunicipalityInput();
                    });
                    cityDropdown.appendChild(item);
                });

                cityDropdown.style.display = 'block';
            });

            cityInput.addEventListener('blur', function() {
                setTimeout(() => {
                    cityDropdown.style.display = 'none';
                }, 200);
            });

            // Активируем поле общин после выбора города
            function enableMunicipalityInput() {
                if (!municipalityInput || !municipalityDropdown) return;
                
                municipalityInput.disabled = false;
                municipalityInput.placeholder = 'Введите название общины...';
                municipalityInput.value = '';
                
                setupMunicipalitySearch();
            }

            function setupMunicipalitySearch() {
                if (!municipalityInput || !municipalityDropdown) return;

                // Удаляем старые обработчики
                const newMunicipalityInput = municipalityInput.cloneNode(true);
                municipalityInput.parentNode.replaceChild(newMunicipalityInput, municipalityInput);
                const updatedMunicipalityInput = document.getElementById(municipalityInputId);
                const updatedMunicipalityDropdown = document.getElementById(municipalityDropdownId);

                updatedMunicipalityInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    if (query.length === 0) {
                        updatedMunicipalityDropdown.style.display = 'none';
                        resetStreet();
                        return;
                    }

                    const filteredMunicipalities = allMunicipalities.filter(municipality => 
                        municipality.toLowerCase().includes(query)
                    );

                    if (filteredMunicipalities.length === 0) {
                        updatedMunicipalityDropdown.style.display = 'none';
                        return;
                    }

                    updatedMunicipalityDropdown.innerHTML = '';
                    filteredMunicipalities.forEach(municipality => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = municipality;
                        item.addEventListener('click', function() {
                            updatedMunicipalityInput.value = municipality;
                            updatedMunicipalityDropdown.style.display = 'none';
                            enableStreetInput();
                        });
                        updatedMunicipalityDropdown.appendChild(item);
                    });

                    updatedMunicipalityDropdown.style.display = 'block';
                });

                updatedMunicipalityInput.addEventListener('focus', function() {
                    // Показываем все общины при фокусе
                    updatedMunicipalityDropdown.innerHTML = '';
                    allMunicipalities.forEach(municipality => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = municipality;
                        item.addEventListener('click', function() {
                            updatedMunicipalityInput.value = municipality;
                            updatedMunicipalityDropdown.style.display = 'none';
                            enableStreetInput();
                        });
                        updatedMunicipalityDropdown.appendChild(item);
                    });
                    updatedMunicipalityDropdown.style.display = 'block';
                });

                updatedMunicipalityInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        updatedMunicipalityDropdown.style.display = 'none';
                    }, 200);
                });
            }

            function enableStreetInput() {
                if (!streetInput || !streetDropdown) return;
                
                streetInput.disabled = false;
                streetInput.placeholder = 'Введите название улицы...';
                streetInput.value = '';
                
                setupStreetSearch();
            }

            function setupStreetSearch() {
                if (!streetInput || !streetDropdown) return;

                // Удаляем старые обработчики
                const newStreetInput = streetInput.cloneNode(true);
                streetInput.parentNode.replaceChild(newStreetInput, streetInput);
                const updatedStreetInput = document.getElementById(streetInputId);
                const updatedStreetDropdown = document.getElementById(streetDropdownId);

                updatedStreetInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    if (query.length === 0) {
                        updatedStreetDropdown.style.display = 'none';
                        return;
                    }

                    const filteredStreets = commonStreets.filter(street => 
                        street.toLowerCase().includes(query)
                    );

                    if (filteredStreets.length === 0) {
                        updatedStreetDropdown.style.display = 'none';
                        return;
                    }

                    updatedStreetDropdown.innerHTML = '';
                    filteredStreets.forEach(street => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = street;
                        item.addEventListener('click', function() {
                            updatedStreetInput.value = street;
                            updatedStreetDropdown.style.display = 'none';
                        });
                        updatedStreetDropdown.appendChild(item);
                    });

                    updatedStreetDropdown.style.display = 'block';
                });

                updatedStreetInput.addEventListener('focus', function() {
                    // Показываем все улицы при фокусе
                    updatedStreetDropdown.innerHTML = '';
                    commonStreets.forEach(street => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = street;
                        item.addEventListener('click', function() {
                            updatedStreetInput.value = street;
                            updatedStreetDropdown.style.display = 'none';
                        });
                        updatedStreetDropdown.appendChild(item);
                    });
                    updatedStreetDropdown.style.display = 'block';
                });

                updatedStreetInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        updatedStreetDropdown.style.display = 'none';
                    }, 200);
                });
            }

            function resetStreet() {
                if (streetInput) {
                    streetInput.value = '';
                    streetInput.disabled = true;
                    streetInput.placeholder = 'Выберите сначала общину...';
                }
            }
        }

        function loadInitialData() {
            clients = [
                { name: "SVDA DOO", mb: "22058282", pib: "114703885", address: "Beograd, Stari grad, Majke Jevrosime 19", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Majke Jevrosime", houseNumber: "19" },
                { name: "AUDITORIA DOO BEOGRAD", mb: "22043277", pib: "114586673", address: "Beograd, Voždovac, Vojvode Dobrnca 48", contact: "", bank: "190-0000000097100 (Алта банка А.Д.)", city: "Beograd", municipality: "Voždovac", street: "Vojvode Dobrnca", houseNumber: "48" },
                { name: "Aleksandra Tarasenko PR", mb: "67249208", pib: "114000935", address: "Novi Sad, Novi Sad, Masarikova 18", contact: "Ugostiteljska radnja Seal & Tea", bank: "", city: "Novi Sad", municipality: "Novi Sad", street: "Masarikova", houseNumber: "18" },
                { name: "Vera Organic Coffee and Tea doo", mb: "21886866", pib: "113543561", address: "Beograd, Stari grad, Nikole Spasića 4", contact: "avmofficebg@gmail.com, 063/773-6698", bank: "", city: "Beograd", municipality: "Stari grad", street: "Nikole Spasića", houseNumber: "4" },
                { name: "ČETIRI COFFEE DOO", mb: "22057146", pib: "114695557", address: "Beograd, Stari grad, Terazije 36", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Terazije", houseNumber: "36" }
            ];

            // Загружаем сохраненные утвержденные инвойсы с их статусами
            const savedInvoices = localStorage.getItem('confirmedInvoices');
            if (savedInvoices) {
                try {
                    confirmedInvoices = JSON.parse(savedInvoices);
                } catch (e) {
                    console.error('Ошибка загрузки инвойсов из localStorage:', e);
                    confirmedInvoices = [];
                }
            }

            // Загружаем сохраненные утвержденные отпремницы
            const savedDeliveries = localStorage.getItem('confirmedDeliveries');
            if (savedDeliveries) {
                try {
                    confirmedDeliveries = JSON.parse(savedDeliveries);
                } catch (e) {
                    console.error('Ошибка загрузки отпремниц из localStorage:', e);
                    confirmedDeliveries = [];
                }
            }

            products = [
                { code: "GF-B-TG210", name: "Tieguanyin/Zeleni Čaj 210g", price: 2297, category: "Zeleni Čaj" },
                { code: "GF-B-EG210", name: "Earl Grey/Crni Čaj 210g", price: 1850, category: "Crni Čaj" },
                { code: "GF-G-JG210", name: "Jasmine Green Beverage/Zeleni Čaj 210g", price: 1837, category: "Zeleni Čaj" },
                { code: "GF-G-SN210", name: "Sencha/Zeleni Čaj 210g", price: 1575, category: "Zeleni Čaj" },
                { code: "GF-B-MO210", name: "Milky Oolong/Zeleni Čaj 210g", price: 2167, category: "Zeleni Čaj" },
                { code: "FJN-B-DHP210", name: "Da Hong Pao/Crni Čaj 210g", price: 2691, category: "Crni Čaj" },
                { code: "FJN-B-GAB210", name: "Gaba Oolong АА/Crni Čaj 210g", price: 4854, category: "Crni Čaj" },
                { code: "FJN-B-DHP28", name: "Da Hong Pao/Crni Čaj 28g", price: 359, category: "Crni Čaj" },
                { code: "GF-W-BMD28", name: "Bai mu dan/Zeleni Čaj 28g", price: 332, category: "Zeleni Čaj" },
                { code: "FJN-B-TG28", name: "Tieguanyin/Zeleni Čaj 28g", price: 307, category: "Zeleni Čaj" },
                { code: "CHC-B-LS28", name: "Lapsang Souchong Black Tea/Crni Čaj 28g", price: 315, category: "Crni Čaj" },
                { code: "CHC-G-MPC25-5", name: "Golden tocha round Pu Erh/Crni Čaj 5g", price: 62, category: "Crni Čaj" },
                { code: "CHC-PU-RS10", name: "Puer Chagao Resin Round/Crni Čaj 1g", price: 32, category: "Crni Čaj" },
                { code: "FJN-B-GAB28", name: "Gaba Oolong АА/Crni Čaj 28g", price: 648, category: "Crni Čaj" },
                { code: "FJN-B-MO28", name: "Milky Oolong/Zeleni Čaj 28g", price: 289, category: "Zeleni Čaj" },
                { code: "GF-B-EG28", name: "Earl Grey/Crni Čaj 28g", price: 307, category: "Crni Čaj" },
                { code: "GF-G-SN28", name: "Sencha/Zeleni Čaj 28g", price: 210, category: "Zeleni Čaj" },
                { code: "GF-G-JG28", name: "Jasmine Green Beverage/Zeleni Čaj 28g", price: 245, category: "Zeleni Čaj" },
                { code: "CHC-B-LS210", name: "Lapsang Souchong Black Tea/Crni Čaj 210g", price: 2100, category: "Crni Čaj" },
                { code: "GF-B-KM210", name: "Keemum/Crni Čaj 210g", price: 1950, category: "Crni Čaj" }
            ];
            renderClientsTable();
            renderProductsTable();
            updateDeliveryClientFilter();
            updateDeliveriesList();
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().split('T')[0];

            document.getElementById('invoiceDate').value = today;
            document.getElementById('invoiceDueDate').value = nextWeekStr;
            document.getElementById('deliveryDate').value = today;
            document.getElementById('deliveryDueDate').value = nextWeekStr;
        }

        function generateUniqueDocumentNumber(existingNumbers, prefix = '') {
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            
            let counter = 1;
            let number = `${counter}-${dateStr}`;
            if (prefix) {
                number = `${prefix}-${counter}-${dateStr}`;
            }
            
            while (existingNumbers.includes(number)) {
                counter++;
                number = prefix ? `${prefix}-${counter}-${dateStr}` : `${counter}-${dateStr}`;
            }
            
            return number;
        }

        function generateDocumentNumbers() {
            // Генерируем уникальные номера для инвойсов
            const existingInvoiceNumbers = confirmedInvoices.map(inv => inv.number);
            const invoiceNumber = generateUniqueDocumentNumber(existingInvoiceNumbers);
            document.getElementById('invoiceNumber').value = invoiceNumber;
            
            // Генерируем уникальные номера для отпремниц
            const existingDeliveryNumbers = confirmedDeliveries.map(del => del.number);
            const deliveryNumber = generateUniqueDocumentNumber(existingDeliveryNumbers);
            document.getElementById('deliveryNumber').value = deliveryNumber;
        }

        function updateSelectOptions() {
            // Инициализируем поисковые поля для клиентов
            initializeClientSearch('invoiceClientSearch', 'invoiceClient', 'invoiceClientDropdown');
            initializeClientSearch('deliveryClientSearch', 'deliveryClient', 'deliveryClientDropdown');
            
            // Инициализируем поисковые поля для товаров
            initializeProductSearch();
        }

        function initializeClientSearch(inputId, hiddenId, dropdownId) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !hidden || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                hidden.value = '';
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const filteredClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) ||
                    client.mb.includes(query) ||
                    client.pib.includes(query)
                );

                if (filteredClients.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = '';
                filteredClients.forEach((client, index) => {
                    const originalIndex = clients.findIndex(c => c.name === client.name && c.mb === client.mb);
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <div style="font-weight: bold;">${client.name}</div>
                        <div style="font-size: 12px; color: #666;">МБ: ${client.mb} | ПИБ: ${client.pib}</div>
                        <div style="font-size: 12px; color: #888;">${client.address}</div>
                    `;
                    item.addEventListener('click', function() {
                        input.value = client.name;
                        hidden.value = originalIndex;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            });

            input.addEventListener('focus', function() {
                if (this.value && dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        function initializeProductSearch() {
            // Инициализация для существующих полей товаров
            document.querySelectorAll('.invoice-product-search').forEach(input => {
                setupProductSearch(input);
            });
            
            document.querySelectorAll('.delivery-product-search').forEach(input => {
                setupProductSearch(input);
            });
        }

        function setupProductSearch(input) {
            const container = input.closest('.searchable-select');
            const hidden = container.querySelector('.invoice-product, .delivery-product');
            const dropdown = container.querySelector('.invoice-product-dropdown, .delivery-product-dropdown');
            
            if (!hidden || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                hidden.value = '';
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const filteredProducts = products.filter(product => 
                    product.code.toLowerCase().includes(query) ||
                    product.name.toLowerCase().includes(query) ||
                    product.category.toLowerCase().includes(query)
                );

                if (filteredProducts.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = '';
                filteredProducts.forEach(product => {
                    const originalIndex = products.findIndex(p => p.code === product.code);
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <div style="font-weight: bold;">${product.code} - ${product.name}</div>
                        <div style="font-size: 12px; color: #666;">Цена: ${product.price.toFixed(2)} RSD | Категория: ${product.category}</div>
                    `;
                    item.addEventListener('click', function() {
                        input.value = `${product.code} - ${product.name}`;
                        hidden.value = originalIndex;
                        dropdown.style.display = 'none';
                        
                        // Обновить цену для инвойсов
                        if (hidden.classList.contains('invoice-product')) {
                            updateInvoiceItemPriceFromSearch(hidden);
                        }
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            });

            input.addEventListener('focus', function() {
                if (this.value && dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        function updateInvoiceItemPriceFromSearch(hiddenInput) {
            const row = hiddenInput.closest('.invoice-items');
            if (!row) return;
            
            const productIndex = hiddenInput.value;
            
            if (productIndex !== '') {
                const product = products[productIndex];
                const priceInput = row.querySelector('.invoice-price');
                const quantityInput = row.querySelector('.invoice-quantity');
                const amountInput = row.querySelector('.invoice-amount');
                
                priceInput.value = product.price.toFixed(2);
                const quantity = parseInt(quantityInput.value) || 1;
                amountInput.value = (product.price * quantity).toFixed(2);
                calculateInvoiceTotals();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => document.body.removeChild(alertDiv), 3000);
        }

        // Клиенты
        function addClient() {
            // Валидируем обязательные поля
            const clientSection = document.getElementById('clients');
            if (!validateRequiredFields(clientSection)) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }

            const name = document.getElementById('clientName').value.trim();
            const legalName = document.getElementById('clientLegalName').value.trim();
            const mb = document.getElementById('clientMB').value.trim();
            const pib = document.getElementById('clientPIB').value.trim();
            const bank = document.getElementById('clientBank').value.trim();
            const isManualInput = document.getElementById('manualAddressInput').checked;
            
            // Новые поля
            const googleMaps = document.getElementById('clientGoogleMaps').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const telegram = document.getElementById('clientTelegram').value.trim();
            const instagram = document.getElementById('clientInstagram').value.trim();
            const installment = document.getElementById('clientInstallment').checked;
            const installmentTerm = document.getElementById('clientInstallmentTerm').value.trim();
            const showcase = document.getElementById('clientShowcase').checked;
            const bar = document.getElementById('clientBar').checked;
            const notes = document.getElementById('clientNotes').value.trim();
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                // Ручной ввод адреса
                address = document.getElementById('clientManualAddress').value.trim();
                
                if (!name || !legalName || !mb || !pib || !address) { 
                    showAlert('Заполните обязательные поля!', 'danger'); 
                    return; 
                }
                
                // Парсим адрес для базовой структуры (опционально)
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
                
            } else {
                // Автоматический ввод адреса
                city = document.getElementById('clientCity').value.trim();
                municipality = document.getElementById('clientMunicipality').value.trim();
                street = document.getElementById('clientStreet').value.trim();
                houseNumber = document.getElementById('clientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) { 
                    showAlert('Заполните обязательные поля!', 'danger'); 
                    return; 
                }

                // Формируем полный адрес
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            const newClient = { 
                name, 
                legalName,
                mb, 
                pib, 
                address, 
                bank, 
                city, 
                municipality, 
                street, 
                houseNumber,
                isManualAddress: isManualInput,
                googleMaps,
                contactPerson,
                phone,
                email,
                telegram,
                instagram,
                installment,
                installmentTerm,
                showcase,
                bar,
                notes,
                // Сохраняем старое поле contact для совместимости
                contact: contactPerson || phone || email || ''
            };
            
            clients.push(newClient);
            addLog(`Добавлен клиент: ${name}`);
            clearClientForm(); 
            renderClientsTable();
            updateSelectOptions();
            showAlert('Клиент добавлен!', 'success');
        }

        function clearClientForm() {
            ['clientName', 'clientLegalName', 'clientMB', 'clientPIB', 'clientCity', 'clientMunicipality', 'clientStreet', 'clientHouseNumber', 'clientBank', 'clientManualAddress', 'clientGoogleMaps', 'clientContactPerson', 'clientPhone', 'clientEmail', 'clientTelegram', 'clientInstagram', 'clientInstallmentTerm', 'clientNotes'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Сбрасываем чекбоксы
            ['clientInstallment', 'clientShowcase', 'clientBar'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.checked = false;
            });
            
            // Сбрасываем чекбокс ручного ввода
            const manualCheckbox = document.getElementById('manualAddressInput');
            if (manualCheckbox) {
                manualCheckbox.checked = false;
                
                // Показываем автоматический ввод, скрываем ручной
                document.getElementById('automaticAddressSection').style.display = 'block';
                document.getElementById('manualAddressSection').style.display = 'none';
            }
            
            // Сбросить состояние полей адреса
            const municipalityInput = document.getElementById('clientMunicipality');
            const streetInput = document.getElementById('clientStreet');
            if (municipalityInput) {
                municipalityInput.disabled = true;
                municipalityInput.placeholder = 'Выберите сначала город...';
            }
            if (streetInput) {
                streetInput.disabled = true;
                streetInput.placeholder = 'Выберите сначала общину...';
            }
            
            // Сбрасываем подсветку полей
            resetFieldHighlighting(document.getElementById('clients'));
        }

        function deleteClient(index) {
            if (confirm('Удалить клиента?')) {
                clients.splice(index, 1); 
                renderClientsTable();
                updateSelectOptions();
                showAlert('Клиент удален!', 'success');
            }
        }

        function renderClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            clients.forEach((client, index) => {
                const row = tbody.insertRow();
                const addressDisplay = client.isManualAddress ? 
                    `<span style="color: #007bff;">📝</span> ${client.address}` : 
                    client.address;
                
                // Добавляем курсор pointer и hover эффект для строки
                row.style.cursor = 'pointer';
                row.style.transition = 'background-color 0.2s ease';
                
                row.innerHTML = `
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;"><strong>${client.name}</strong></td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.mb}</td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.pib}</td>
                    <td onclick="openClientProfile(${index})" style="max-width: 200px; word-wrap: break-word; padding: 15px 10px;">${addressDisplay}</td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.contactPerson || client.contact || '-'}</td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.bank || '-'}</td>
                    <td style="padding: 15px 10px;">
                        <button class="btn btn-secondary" onclick="showClientHistory('${client.name.replace(/'/g, "\\'")}')" style="margin-right: 5px;">История</button>
                        <button class="btn btn-danger" onclick="deleteClient(${index})">Удалить</button>
                    </td>
                `;
                
                // Добавляем hover эффект
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }

        // Товары
        function addProduct() {
            // Валидируем обязательные поля
            const productSection = document.getElementById('products');
            if (!validateRequiredFields(productSection)) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }

            const code = document.getElementById('productCode').value.trim();
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            const weight = parseFloat(document.getElementById('productWeight').value) || 0;
            
            if (!code || !name || !price || price <= 0) { 
                showAlert('Заполните поля корректно!', 'danger'); 
                return; 
            }
            if (products.find(p => p.code === code)) { 
                showAlert('Код уже существует!', 'danger'); 
                return; 
            }
            
            const newProduct = { code, name, price, category, weight };
            products.push(newProduct);
            addLog(`Добавлен товар: ${name} (код: ${code}, вес: ${weight}г)`);
            clearProductForm(); 
            renderProductsTable();
            updateSelectOptions();
            showAlert('Товар добавлен!', 'success');
        }

        function clearProductForm() {
            ['productCode', 'productName', 'productPrice', 'productCategory', 'productWeight'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Сбрасываем подсветку полей
            resetFieldHighlighting(document.getElementById('products'));
        }

        function deleteProduct(index) {
            if (confirm('Удалить товар?')) {
                products.splice(index, 1); 
                renderProductsTable();
                updateSelectOptions();
                showAlert('Товар удален!', 'success');
            }
        }

        let currentEditingProductIndex = null;

        function editProduct(index) {
            const product = products[index];
            if (!product) return;

            currentEditingProductIndex = index;

            // Заполняем форму данными товара
            document.getElementById('editProductCode').value = product.code || '';
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductPrice').value = product.price || '';
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductWeight').value = product.weight || '';

            // Показываем модальное окно
            document.getElementById('editProductModal').style.display = 'block';
            addLog(`Открыто редактирование товара: ${product.name}`);
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            currentEditingProductIndex = null;
        }

        function saveProductChanges() {
            if (currentEditingProductIndex === null) return;

            // Валидируем обязательные поля в модальном окне
            const editProductModal = document.getElementById('editProductModal');
            if (!validateRequiredFields(editProductModal)) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }

            const code = document.getElementById('editProductCode').value.trim();
            const name = document.getElementById('editProductName').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const category = document.getElementById('editProductCategory').value;
            const weight = parseFloat(document.getElementById('editProductWeight').value) || 0;

            if (!code || !name || !price || price <= 0) {
                showAlert('Заполните все обязательные поля корректно!', 'danger');
                return;
            }

            // Проверяем, не занят ли код другим товаром
            const existingProduct = products.find((p, idx) => p.code === code && idx !== currentEditingProductIndex);
            if (existingProduct) {
                showAlert('Товар с таким кодом уже существует!', 'danger');
                return;
            }

            const oldProduct = products[currentEditingProductIndex];
            const oldCode = oldProduct.code;
            const oldName = oldProduct.name;

            // Обновляем товар
            products[currentEditingProductIndex] = {
                code,
                name,
                price,
                category,
                weight
            };

            // Сохраняем в localStorage
            localStorage.setItem('products', JSON.stringify(products));

            // Обновляем интерфейс
            renderProductsTable();
            updateSelectOptions();
            closeEditProductModal();

            addLog(`Обновлен товар: ${oldName} (${oldCode}) → ${name} (${code})`);
            showAlert('Товар успешно обновлен!', 'success');
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            products.forEach((product, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${product.code}</strong></td>
                    <td>${product.name}</td>
                    <td>${product.price.toFixed(2)} RSD</td>
                    <td>${product.category}</td>
                    <td>${product.weight || 0} г</td>
                    <td>
                        <button class="btn btn-primary" onclick="editProduct(${index})" style="margin-right: 5px;">Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${index})">Удалить</button>
                    </td>
                `;
            });
        }

        // Склад
        let productGroups = JSON.parse(localStorage.getItem('productGroups')) || [];

        // Обновление единиц измерения при изменении типа количества
        document.addEventListener('DOMContentLoaded', function() {
            const quantityTypeSelect = document.getElementById('groupQuantityType');
            const reservationTypeSelect = document.getElementById('groupReservationType');
            const quantityUnit = document.getElementById('quantityUnit');
            const reservationUnit = document.getElementById('reservationUnit');
            
            if (quantityTypeSelect) {
                quantityTypeSelect.addEventListener('change', function() {
                    quantityUnit.textContent = this.value === 'weight' ? 'г' : 'ед.';
                });
            }
            
            if (reservationTypeSelect) {
                reservationTypeSelect.addEventListener('change', function() {
                    reservationUnit.textContent = this.value === 'weight' ? 'г' : 'ед.';
                });
            }
        });

        function createProductGroup() {
            // Валидируем обязательные поля
            const warehouseSection = document.getElementById('warehouse');
            if (!validateRequiredFields(warehouseSection)) {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }

            const name = document.getElementById('groupName').value.trim();
            const quantityType = document.getElementById('groupQuantityType').value;
            const quantity = parseFloat(document.getElementById('groupQuantity').value);
            const shipmentDate = document.getElementById('groupShipmentDate').value;
            const reservationType = document.getElementById('groupReservationType').value;
            const reservation = parseFloat(document.getElementById('groupReservation').value);

            if (!name || !quantity || quantity <= 0) {
                showAlert('Заполните обязательные поля корректно!', 'danger');
                return;
            }

            // Рассчитываем изначальный остаток: общее количество - 5% - резервации
            const fivePercentDeduction = quantity * 0.05;
            const reservationAmount = reservation || 0;
            const initialStock = Math.max(0, quantity - fivePercentDeduction - reservationAmount);
            const initialPercentage = (initialStock / quantity) * 100;

            const newGroup = {
                id: Date.now(),
                name,
                quantityType,
                quantity: initialStock,
                originalQuantity: quantity,
                shipmentDate,
                reservationType,
                reservation,
                products: [],
                remainingPercentage: initialPercentage,
                createdAt: new Date().toISOString()
            };

            productGroups.push(newGroup);
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`Создана группа товаров: ${name}`);
            clearGroupForm();
            renderProductGroups();
            showAlert('Группа товаров создана!', 'success');
        }

        function clearGroupForm() {
            ['groupName', 'groupQuantity', 'groupShipmentDate', 'groupReservation'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // Сбрасываем подсветку полей
            resetFieldHighlighting(document.getElementById('warehouse'));
        }

        function renderProductGroups() {
            const container = document.getElementById('productGroupsList');
            if (!container) return;

            if (productGroups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">Группы товаров не созданы</p>';
                return;
            }

            container.innerHTML = productGroups.map(group => {
                const percentageClass = group.remainingPercentage > 50 ? '' : 
                                      group.remainingPercentage > 20 ? 'medium' : 'low';
                
                const quantityUnit = group.quantityType === 'weight' ? 'г' : 'ед.';
                const reservationUnit = group.reservationType === 'weight' ? 'г' : 'ед.';
                
                return `
                    <div class="product-group" id="group-${group.id}">
                        <div class="group-header" onclick="toggleGroup(${group.id})">
                            <div>
                                <h4>${group.name}</h4>
                                <div class="group-info">
                                    <span>Общее количество: ${group.originalQuantity} ${quantityUnit}</span>
                                    <span>Остаток на складе: ${group.quantity.toFixed(1)} ${quantityUnit}</span>
                                    <span>Продано: ${((group.originalQuantity - (group.originalQuantity * 0.05) - (group.reservation || 0)) - group.quantity).toFixed(1)} ${quantityUnit}</span>
                                    ${group.shipmentDate ? `<span>Отгрузка: ${new Date(group.shipmentDate).toLocaleDateString()}</span>` : ''}
                                    <span>Товаров в группе: ${group.products.length}</span>
                                </div>
                            </div>
                            <span class="group-expand-icon">▶</span>
                        </div>
                        <div class="group-content">
                            <div class="group-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Общее количество</div>
                                    <div class="stat-value">${group.originalQuantity} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Списание 5%</div>
                                    <div class="stat-value">-${(group.originalQuantity * 0.05).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Резервации на месяц</div>
                                    <div class="stat-value">-${(group.reservation || 0).toFixed(1)} ${reservationUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Поступило на склад</div>
                                    <div class="stat-value">${(group.originalQuantity - (group.originalQuantity * 0.05) - (group.reservation || 0)).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Остаток на складе</div>
                                    <div class="stat-value">${group.quantity.toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Продано</div>
                                    <div class="stat-value">${((group.originalQuantity - (group.originalQuantity * 0.05) - (group.reservation || 0)) - group.quantity).toFixed(1)} ${quantityUnit}</div>
                                </div>
                            </div>
                            
                            <!-- Товары в группе -->
                            <div class="add-products-section">
                                <h5>Товары в группе (${group.products.length})</h5>
                                <div class="products-in-group" style="margin-bottom: 20px;">
                                    ${group.products.length === 0 ? 
                                        '<p style="color: #666; margin: 10px 0; text-align: center; font-style: italic;">Товары не добавлены в группу</p>' :
                                        group.products.map((productInGroup, index) => {
                                            const product = products.find(p => p.code === productInGroup.code);
                                            return product ? `
                                                <div class="product-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #007bff;">
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${product.name}</div>
                                                        <div style="font-size: 12px; color: #666;">
                                                            <span style="margin-right: 15px;"><strong>Код:</strong> ${product.code}</span>
                                                            <span style="margin-right: 15px;"><strong>Вес:</strong> ${product.weight}г</span>
                                                            <span style="margin-right: 15px;"><strong>Цена:</strong> ${product.price.toFixed(2)} RSD</span>
                                                            <span><strong>Категория:</strong> ${product.category || 'Не указана'}</span>
                                                        </div>
                                                    </div>
                                                    <button class="btn btn-danger btn-sm" onclick="removeProductFromGroup(${group.id}, ${index})" style="margin-left: 10px;">Удалить</button>
                                                </div>
                                            ` : '';
                                        }).join('')
                                    }
                                </div>
                                
                                <h5>Добавить товар</h5>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <div class="searchable-select" style="flex: 1;">
                                        <input type="text" class="searchable-input group-product-search" id="groupProductSearch-${group.id}" placeholder="Введите код или название товара..." autocomplete="off">
                                        <input type="hidden" class="group-product-code" id="groupProductCode-${group.id}" value="">
                                        <div class="dropdown-menu group-product-dropdown" id="groupProductDropdown-${group.id}"></div>
                                    </div>
                                    <button class="btn btn-primary" onclick="addProductToGroup(${group.id})" style="min-width: 100px;">Добавить</button>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; text-align: right;">
                                <button class="btn btn-danger" onclick="deleteProductGroup(${group.id})">Удалить группу</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleGroup(groupId) {
            const groupElement = document.getElementById(`group-${groupId}`);
            if (groupElement) {
                groupElement.classList.toggle('group-expanded');
            }
        }

        function addProductToGroup(groupId) {
            const productCodeElement = document.getElementById(`groupProductCode-${groupId}`);
            const productSearchElement = document.getElementById(`groupProductSearch-${groupId}`);
            const productCode = productCodeElement.value;
            
            if (!productCode) {
                showAlert('Выберите товар!', 'warning');
                return;
            }

            const product = products.find(p => p.code === productCode);
            if (!product) {
                showAlert('Товар не найден!', 'danger');
                return;
            }

            if (!product.weight || product.weight <= 0) {
                showAlert('Товар должен иметь указанный вес!', 'warning');
                return;
            }

            const group = productGroups.find(g => g.id === groupId);
            if (!group) {
                showAlert('Группа не найдена!', 'danger');
                return;
            }

            // Проверяем, не добавлен ли уже этот товар
            if (group.products.find(p => p.code === productCode)) {
                showAlert('Товар уже добавлен в группу!', 'warning');
                return;
            }

            group.products.push({
                code: productCode,
                addedAt: new Date().toISOString()
            });

            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`Товар ${product.name} добавлен в группу ${group.name}`);
            productCodeElement.value = '';
            productSearchElement.value = '';
            renderProductGroups();
            showAlert('Товар добавлен в группу!', 'success');
        }

        function removeProductFromGroup(groupId, productIndex) {
            const group = productGroups.find(g => g.id === groupId);
            if (!group) return;

            const product = products.find(p => p.code === group.products[productIndex].code);
            group.products.splice(productIndex, 1);
            
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`Товар ${product ? product.name : 'неизвестный'} удален из группы ${group.name}`);
            renderProductGroups();
            showAlert('Товар удален из группы!', 'success');
        }

        function deleteProductGroup(groupId) {
            if (!confirm('Удалить группу товаров?')) return;

            const groupIndex = productGroups.findIndex(g => g.id === groupId);
            if (groupIndex === -1) return;

            const group = productGroups[groupIndex];
            productGroups.splice(groupIndex, 1);
            
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`Удалена группа товаров: ${group.name}`);
            renderProductGroups();
            showAlert('Группа товаров удалена!', 'success');
        }

        // Функция для обновления остатков при создании инвойса
        function updateGroupStockOnInvoice(invoiceItems) {
            let updated = false;
            
            invoiceItems.forEach(item => {
                // Товар хранится в item.product, а не item.code
                const product = item.product;
                if (!product || !product.weight) return;
                
                // Находим все группы, которые содержат этот товар
                productGroups.forEach(group => {
                    const productInGroup = group.products.find(p => p.code === product.code);
                    if (productInGroup && group.quantityType === 'weight') {
                        // Уменьшаем количество в группе на основе веса товара и количества в инвойсе
                        const weightUsed = product.weight * item.quantity;
                        const newQuantity = Math.max(0, group.quantity - weightUsed);
                        
                        console.log(`Обновление группы "${group.name}": товар ${product.code}, вес ${product.weight}г × ${item.quantity} = ${weightUsed}г, остаток: ${group.quantity}г → ${newQuantity}г`);
                        
                        group.quantity = newQuantity;
                        
                        // Пересчитываем процент остатка
                        group.remainingPercentage = (group.quantity / group.originalQuantity) * 100;
                        updated = true;
                    }
                });
            });
            
            if (updated) {
                localStorage.setItem('productGroups', JSON.stringify(productGroups));
                renderProductGroups(); // Обновляем отображение групп
                addLog(`Обновлены остатки склада после утверждения инвойса`);
            }
        }

        // Инвойсы
        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            if(!container) return;

            const newItem = document.createElement('div');
            newItem.className = 'invoice-items';
            
            newItem.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Товар *</label>
                    <div class="searchable-select">
                        <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                        <input type="hidden" class="invoice-product" value="">
                        <div class="dropdown-menu invoice-product-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Количество</label>
                    <input type="number" class="invoice-quantity" value="1" min="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Цена (RSD)</label>
                    <input type="number" class="invoice-price" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Сумма (RSD)</label>
                    <input type="number" class="invoice-amount" readonly style="background: #f8f9fa; font-weight: bold;">
                </div>
                <div style="padding-top: 25px;">
                    <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // Инициализировать поиск для нового поля
            const newSearch = newItem.querySelector('.invoice-product-search');
            setupProductSearch(newSearch);
            addLog('Добавлен товар в инвойс');
        }

        function removeInvoiceItem(button) {
            const container = document.getElementById('invoiceItems');
            if(!container) return;
            
            if (container.children.length > 1) {
                button.closest('.invoice-items').remove();
                calculateInvoiceTotals();
            } else {
                showAlert('Должен остаться хотя бы один товар!', 'danger');
            }
        }

        function calculateInvoiceTotals() {
            const amounts = document.querySelectorAll('.invoice-amount');
            let subtotal = 0;
            amounts.forEach(input => subtotal += parseFloat(input.value) || 0);
            
            const vatRate = parseFloat(document.getElementById('invoiceVAT').value) || 0;
            const vatAmount = subtotal * (vatRate / 100);
            const total = subtotal + vatAmount;

            document.getElementById('invoiceSubtotal').textContent = subtotal.toFixed(2) + ' RSD';
            document.getElementById('invoiceVATAmount').textContent = vatAmount.toFixed(2) + ' RSD';
            document.getElementById('invoiceTotal').textContent = total.toFixed(2) + ' RSD';
        }

        function generateInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;
            const vatRate = document.getElementById('invoiceVAT').value;

            if (!invoiceNumber || !invoiceDate || !invoiceDueDate || clientIndex === '') {
                showAlert('Заполните все обязательные поля!', 'danger'); 
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('.invoice-items');
            
            itemRows.forEach(row => {
                const hiddenProduct = row.querySelector('.invoice-product');
                const productIndex = hiddenProduct.value;
                const quantity = parseInt(row.querySelector('.invoice-quantity').value);
                const amount = parseFloat(row.querySelector('.invoice-amount').value) || 0;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        price: product.price,
                        amount: amount
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте хотя бы один товар!', 'danger');
                return;
            }

            const client = clients[clientIndex];
            
            // Проверяем адрес доставки
            let deliveryAddress = client.address;
            const isDifferentAddress = document.getElementById('differentDeliveryAddress').checked;
            
            if (isDifferentAddress) {
                const deliveryCity = document.getElementById('deliveryCity').value.trim();
                const deliveryMunicipality = document.getElementById('deliveryMunicipality').value.trim();
                const deliveryStreet = document.getElementById('deliveryStreet').value.trim();
                const deliveryHouseNumber = document.getElementById('deliveryHouseNumber').value.trim();
                
                if (!deliveryCity || !deliveryMunicipality || !deliveryStreet) {
                    showAlert('Заполните все поля адреса доставки!', 'danger');
                    return;
                }
                
                deliveryAddress = `${deliveryCity}, ${deliveryMunicipality}, ${deliveryStreet}`;
                if (deliveryHouseNumber) {
                    deliveryAddress += ` ${deliveryHouseNumber}`;
                }
            }
            
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const vatAmount = subtotal * (parseFloat(vatRate) / 100);
            const total = subtotal + vatAmount;

            currentInvoiceData = {
                number: invoiceNumber,
                date: invoiceDate,
                dueDate: invoiceDueDate,
                client: client,
                items: items,
                delivery: delivery,
                deliveryAddress: deliveryAddress,
                isDifferentDeliveryAddress: isDifferentAddress,
                vatRate: parseFloat(vatRate),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total
            };

            const invoiceHTML = generateInvoiceHTML(currentInvoiceData);
            document.getElementById('invoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoicePreview').style.display = 'block';
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('invoiceConfirmMessage').style.display = 'none';
        }

        function generateInvoiceHTML(invoice) {
            let itemsHTML = '';
            invoice.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px;">${item.price.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px; font-weight: bold;">${item.amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <!-- Заголовок с логотипом -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Studentski Trg 4</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">Račun</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${invoice.number}</p>
                            <div style="margin-top: 12px;">
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>Balance Due:</strong> ${invoice.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                            </div>
                        </div>
                    </div>

                    <!-- Информация о клиенте и доставке -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Poručioc:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ')[0]}</p>
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ').slice(1).join(' ')}</p>
                                ${invoice.client.contact && invoice.client.contact.includes('Ugostiteljska') ? '<p style="margin: 0;">Ugostiteljska radnja</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Seal') ? '<p style="margin: 0;">Seal</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Tea') ? '<p style="margin: 0;">& Tea</p>' : ''}
                                <p style="margin: 0;">${invoice.client.address.split(',')[1] ? invoice.client.address.split(',')[1].trim() : 'Novi Sad'}</p>
                                <p style="margin: 0;">Matični broj: ${invoice.client.mb}</p>
                                <p style="margin: 0;">PIB: ${invoice.client.pib}</p>
                                <p style="margin: 0;">Sedište: ${invoice.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Isporuka na adresu::</h4>
                            <p style="margin: 0; font-size: 10px;">${invoice.deliveryAddress || invoice.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Način:</strong> ${invoice.delivery}</p>
                        </div>
                    </div>

                    <!-- Таблица товаров -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Proizvod</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">količina</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">cena</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">iznos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <!-- Итоги -->
                    <div style="text-align: right; margin-bottom: 15px;">
                        <div style="display: inline-block; text-align: right;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>Subtotal:</strong> ${invoice.subtotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                            <p style="margin: 2px 0; font-size: 12px;"><strong>PDV (${invoice.vatRate}%):</strong> ${invoice.vatAmount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                            <p style="margin: 6px 0 2px 0; font-size: 14px; font-weight: bold; color: #333;"><strong>Total:</strong> ${invoice.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                        </div>
                    </div>
                    
                    <!-- Банковские реквизиты -->
                    <div style="margin-top: 15px;">
                        <h4 style="margin: 0 0 4px 0; font-size: 10px;">Podaci o računima za prijem naknade :</h4>
                        <p style="margin: 1px 0; font-size: 10px;">Broj računa: 190-0000000085540-29</p>
                        <p style="margin: 1px 0; font-size: 10px;">Kod: Alta Banka ad Beograd</p>
                        <p style="margin: 1px 0; font-size: 10px;">Adresa banke: Beograd, Novi Beograd, Bulevar Zorana Đinđića 121</p>
                        <p style="margin: 8px 0 1px 0; font-size: 10px;">Plaćanje sa pozivom na broj: ATSNS${invoice.number.replace(/-/g, '')}</p>
                    </div>
                    
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                    </style>
                </div>
            `;
        }

        function confirmInvoice() {
            if (!currentInvoiceData) { 
                showAlert('Нет данных инвойса!', 'danger'); 
                return; 
            }
            
            if (confirmedInvoices.find(inv => inv.number === currentInvoiceData.number)) { 
                showAlert('Инвойс уже утвержден!', 'danger'); 
                return; 
            }
            
            // Обновляем остатки в группах товаров
            updateGroupStockOnInvoice(currentInvoiceData.items);
            
            confirmedInvoices.push({ ...currentInvoiceData, confirmedDate: new Date().toISOString() });
            updateStatistics();
            document.getElementById('invoiceConfirmMessage').style.display = 'block';
            showAlert('Инвойс утвержден!', 'success');
        }

        function exportInvoiceToPDF() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Рачун ${currentInvoiceData.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            // Создаем временное окно для печати
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                // Ждем загрузки содержимого и запускаем печать
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        // Автоматически закрываем окно после печати (если пользователь не отменил)
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback для браузеров, блокирующих попапы
                downloadInvoiceAsHTML();
            }
            
            showAlert('Инвойс готов для экспорта!', 'success');
        }

        function downloadInvoiceAsHTML() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Рачун ${currentInvoiceData.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            // Создаем blob и скачиваем файл
            const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Racun_${currentInvoiceData.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Освобождаем память
            URL.revokeObjectURL(url);
            showAlert('HTML файл инвойса скачан!', 'success');
        }

        function copyInvoiceToClipboard() {
            const invoiceContent = document.getElementById('invoiceContent');
            if (!invoiceContent) {
                showAlert('Нет содержимого для копирования!', 'danger');
                return;
            }

            // Создаем временный элемент для копирования
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = invoiceContent.innerHTML;
            
            // Убираем стили для чистого текста
            const textContent = tempDiv.innerText || tempDiv.textContent;
            
            // Пытаемся скопировать в буфер обмена
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textContent).then(() => {
                    showAlert('Инвойс скопирован в буфер обмена!', 'success');
                }).catch(err => {
                    console.error('Ошибка копирования:', err);
                    fallbackCopyTextToClipboard(textContent);
                });
            } else {
                fallbackCopyTextToClipboard(textContent);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('Инвойс скопирован в буфер обмена!', 'success');
                } else {
                    showAlert('Не удалось скопировать в буфер обмена', 'danger');
                }
            } catch (err) {
                console.error('Ошибка копирования:', err);
                showAlert('Не удалось скопировать в буфер обмена', 'danger');
            }
            
            document.body.removeChild(textArea);
        }

        function generateDeliveryFromInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;

            if (!invoiceNumber || !invoiceDate || !invoiceDueDate || clientIndex === '') {
                showAlert('Сначала заполните данные инвойса!', 'danger');
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('.invoice-items');
            
            itemRows.forEach(row => {
                const productIndex = row.querySelector('.invoice-product').value;
                const quantity = parseInt(row.querySelector('.invoice-quantity').value);

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте товары в инвойс!', 'danger');
                return;
            }

            showTab('delivery');
            
            // Генерируем уникальный номер для отпремницы
            const existingDeliveryNumbers = confirmedDeliveries.map(del => del.number);
            const deliveryNumber = generateUniqueDocumentNumber(existingDeliveryNumbers);
            document.getElementById('deliveryNumber').value = deliveryNumber;
            document.getElementById('deliveryDate').value = invoiceDate;
            document.getElementById('deliveryDueDate').value = invoiceDueDate;
            document.getElementById('deliveryClient').value = clientIndex;
            document.getElementById('deliveryMethod').value = delivery;

            const container = document.getElementById('deliveryItems');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.code === item.product.code);
                
                const newItem = document.createElement('div');
                newItem.className = 'delivery-items';
                newItem.innerHTML = `
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Товар *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input delivery-product-search" placeholder="Введите код или название товара..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                            <input type="hidden" class="delivery-product" value="${productIndex}">
                            <div class="dropdown-menu delivery-product-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Количество</label>
                        <input type="number" class="delivery-quantity" value="${item.quantity}" min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Единица</label>
                        <input type="text" class="delivery-unit" value="ком" readonly>
                    </div>
                    <div style="padding-top: 25px;">
                        <button class="btn btn-danger" onclick="removeDeliveryItem(this)">Удалить</button>
                    </div>
                `;
                container.appendChild(newItem);
                
                // Инициализировать поиск для нового поля
                const newSearch = newItem.querySelector('.delivery-product-search');
                setupProductSearch(newSearch);
            });

            showAlert('Данные инвойса скопированы в отпремницу!', 'success');
        }

        // Отпремницы
        function addDeliveryItem() {
            const container = document.getElementById('deliveryItems');
            if(!container) return;

            const newItem = document.createElement('div');
            newItem.className = 'delivery-items';
            
            newItem.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Товар *</label>
                    <div class="searchable-select">
                        <input type="text" class="searchable-input delivery-product-search" placeholder="Введите код или название товара..." autocomplete="off">
                        <input type="hidden" class="delivery-product" value="">
                        <div class="dropdown-menu delivery-product-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Количество</label>
                    <input type="number" class="delivery-quantity" value="1" min="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Единица</label>
                    <input type="text" class="delivery-unit" value="ком" readonly>
                </div>
                <div style="padding-top: 25px;">
                    <button class="btn btn-danger" onclick="removeDeliveryItem(this)">Удалить</button>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // Инициализировать поиск для нового поля
            const newSearch = newItem.querySelector('.delivery-product-search');
            setupProductSearch(newSearch);
            addLog('Добавлен товар в отпремницу');
        }

        function removeDeliveryItem(button) {
            const container = document.getElementById('deliveryItems');
            if(!container) return;
            
            if (container.children.length > 1) {
                button.closest('.delivery-items').remove();
            } else {
                showAlert('Должен остаться хотя бы один товар!', 'danger');
            }
        }

        function generateDelivery() {
            const deliveryNumber = document.getElementById('deliveryNumber').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryDueDate = document.getElementById('deliveryDueDate').value;
            const clientIndex = document.getElementById('deliveryClient').value;
            const method = document.getElementById('deliveryMethod').value;

            if (!deliveryNumber || !deliveryDate || !deliveryDueDate || clientIndex === '') {
                showAlert('Заполните все обязательные поля!', 'danger');
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('.delivery-items');
            
            itemRows.forEach(row => {
                const hiddenProduct = row.querySelector('.delivery-product');
                const productIndex = hiddenProduct.value;
                const quantity = parseInt(row.querySelector('.delivery-quantity').value);
                const unit = row.querySelector('.delivery-unit').value;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            if (items.length === 0) {
                showAlert('Добавьте хотя бы один товар!', 'danger');
                return;
            }

            const client = clients[clientIndex];

            let itemsHTML = '';
            items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.unit}</td>
                    </tr>
                `;
            });

            const deliveryHTML = `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Мајке Јевросиме 35</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">ОТПРЕМНИЦА</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${deliveryNumber}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Поручилац:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${client.legalName || client.name}</p>
                                <p style="margin: 0;">Matični broj: ${client.mb}</p>
                                <p style="margin: 0;">PIB: ${client.pib}</p>
                                <p style="margin: 0;">Sedište: ${client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Испорука на адресу:</h4>
                            <p style="margin: 0; font-size: 10px;">${client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Начин:</strong> ${method}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Дата:</strong> ${new Date(deliveryDate).toLocaleDateString('sr-RS')}</p>
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Рок испоруке:</strong> ${new Date(deliveryDueDate).toLocaleDateString('sr-RS')}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Назив артикла</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Количина</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Јединица мере</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Издао</strong></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Примио</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        Овај документ је генерисан електронски и важи без печата и потписа
                    </div>
                </div>
            `;

            document.getElementById('deliveryContent').innerHTML = deliveryHTML;
            document.getElementById('deliveryPreview').style.display = 'block';
            document.getElementById('deliveryPreview').scrollIntoView({ behavior: 'smooth' });
            
            // Сохраняем данные отпремницы для возможного утверждения
            window.currentDeliveryData = {
                number: deliveryNumber,
                date: deliveryDate,
                dueDate: deliveryDueDate,
                client: client,
                method: method,
                items: items,
                signed: false
            };
        }

        function confirmDelivery() {
            if (!window.currentDeliveryData) {
                showAlert('Сначала сгенерируйте отпремницу!', 'danger');
                return;
            }
            
            confirmedDeliveries.push(window.currentDeliveryData);
            localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
            
            updateDeliveriesList();
            updateDeliveryClientFilter();
            
            addLog(`Утверждена отпремница #${window.currentDeliveryData.number} для клиента ${window.currentDeliveryData.client.name}`);
            showAlert('Отпремница утверждена и добавлена в список!', 'success');
            
            window.currentDeliveryData = null;
        }

        function printDelivery() {
            const deliveryContent = document.getElementById('deliveryContent').innerHTML;
            const deliveryNumber = document.getElementById('deliveryNumber').value;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отпремница ${deliveryNumber}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback - скачивание HTML файла
                const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Otpremnica_${deliveryNumber.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            }
            
            showAlert('Отпремница готова для экспорта!', 'success');
        }

        // Статистика
        function initializeStatistics() {
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            
            document.getElementById('statsFromDate').value = firstDayOfYear.toISOString().split('T')[0];
            document.getElementById('statsToDate').value = today.toISOString().split('T')[0];
            
            updateStatistics();
        }

        let currentFilteredInvoices = []; // Глобальная переменная для хранения текущих отфильтрованных инвойсов

        function updateStatistics() {
            const fromDate = new Date(document.getElementById('statsFromDate').value);
            const toDate = new Date(document.getElementById('statsToDate').value);
            toDate.setHours(23, 59, 59, 999);
            
            const filteredInvoices = confirmedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= fromDate && invoiceDate <= toDate;
            });

            currentFilteredInvoices = filteredInvoices; // Сохраняем для поиска

            const totalRevenue = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoicesCount = filteredInvoices.length;
            const uniqueClients = new Set(filteredInvoices.map(inv => inv.client.name)).size;
            const averageOrder = totalInvoicesCount > 0 ? totalRevenue / totalInvoicesCount : 0;

            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' RSD';
            document.getElementById('totalInvoices').textContent = totalInvoicesCount;
            document.getElementById('totalClients').textContent = uniqueClients;
            document.getElementById('averageOrder').textContent = averageOrder.toFixed(2) + ' RSD';

            // Очищаем поле поиска при обновлении статистики
            document.getElementById('invoiceSearchInput').value = '';
            
            updateInvoicesList(filteredInvoices);
            updateRevenueChart(filteredInvoices);
            updateProductsChart(filteredInvoices);
            updateClientsChart(filteredInvoices);
        }

        function filterInvoicesBySearch() {
            const searchTerm = document.getElementById('invoiceSearchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                // Если поле поиска пустое, показываем все инвойсы из текущего фильтра
                updateInvoicesList(currentFilteredInvoices);
                return;
            }

            // Фильтруем инвойсы по номеру
            const searchResults = currentFilteredInvoices.filter(invoice => 
                invoice.number.toLowerCase().includes(searchTerm)
            );

            updateInvoicesList(searchResults);
        }

        function updateRevenueChart(invoices) {
            const chartEl = document.getElementById('revenueChart');
            if(!chartEl) return;

            if (invoices.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            let chartHTML = '<div style="display: flex; align-items: end; height: 200px; gap: 10px; padding: 20px;">';
            const maxValue = Math.max(...Object.values(monthlyData));
            const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
            
            Object.entries(monthlyData).forEach(([monthKey, value]) => {
                const [year, month] = monthKey.split('-');
                const monthName = months[parseInt(month) - 1];
                const height = (value / maxValue) * 150;
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="font-size: 12px; margin-bottom: 5px; font-weight: bold;">${value.toFixed(0)} RSD</div>
                        <div style="width: 40px; height: ${height}px; background: linear-gradient(to top, #212529, #343a40); border-radius: 4px 4px 0 0;"></div>
                        <div style="font-size: 12px; margin-top: 5px; text-align: center;">${monthName}<br>${year}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateProductsChart(invoices) {
            const chartEl = document.getElementById('productsChart');
            if(!chartEl) return;

            const productData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const key = item.product.code;
                    if (!productData[key]) {
                        productData[key] = {
                            name: item.product.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity;
                    productData[key].revenue += item.amount;
                });
            });

            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            if (sortedProducts.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const maxRevenue = sortedProducts[0][1].revenue;
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedProducts.forEach(([code, data]) => {
                const percentage = (data.revenue / maxRevenue) * 100;
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">${code}</span>
                            <span style="font-size: 14px;">${data.revenue.toFixed(2)} RSD (${data.quantity} шт)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #28a745, #20c997); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateClientsChart(invoices) {
            const chartEl = document.getElementById('clientsChart');
            if(!chartEl) return;

            const clientData = {};
            invoices.forEach(invoice => {
                const clientName = invoice.client.name;
                clientData[clientName] = (clientData[clientName] || 0) + invoice.total;
            });

            const sortedClients = Object.entries(clientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (sortedClients.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Нет данных за выбранный период</div>';
                return;
            }

            const maxRevenue = sortedClients[0][1];
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedClients.forEach(([clientName, revenue]) => {
                const percentage = (revenue / maxRevenue) * 100;
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">${clientName}</span>
                            <span style="font-size: 14px;">${revenue.toFixed(2)} RSD</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #212529, #343a40); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateInvoicesList(invoices) {
            const container = document.getElementById('confirmedInvoicesList');
            if(!container) return;

            if (invoices.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Нет утвержденных инвойсов за выбранный период</p>';
                return;
            }

            let listHTML = '';
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                const isDelivered = invoice.delivered || false;
                const isPaid = invoice.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Инвойс #${invoice.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} • ${date} • ${invoice.total.toFixed(2)} RSD</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${invoice.items.length} • НДС: ${invoice.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isDelivered ? '#28a745' : '#6c757d'};">Доставлен</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isPaid ? '#28a745' : '#6c757d'};">Оплачен</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="Просмотреть инвойс">Просмотр</button>
                            <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="Копировать данные в новый инвойс">Копировать</button>
                            <span class="invoice-status">Утвержден</span>
                            <button class="btn btn-danger" onclick="removeInvoiceFromStats('${invoice.number}')">Удалить</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = listHTML;
        }

        function toggleInvoiceStatus(invoiceNumber, statusType, isChecked) {
            const invoice = confirmedInvoices.find(inv => inv.number === invoiceNumber);
            if (invoice) {
                if (statusType === 'delivered') {
                    invoice.delivered = isChecked;
                    addLog(`Инвойс #${invoiceNumber} отмечен как ${isChecked ? 'доставленный' : 'недоставленный'}`);
                } else if (statusType === 'paid') {
                    invoice.paid = isChecked;
                    addLog(`Инвойс #${invoiceNumber} отмечен как ${isChecked ? 'оплаченный' : 'неоплаченный'}`);
                }
                
                // Сохраняем обновленные данные в localStorage
                localStorage.setItem('confirmedInvoices', JSON.stringify(confirmedInvoices));
                
                // Обновляем отображение для изменения цвета текста
                updateStatistics();
            }
        }

        function removeInvoiceFromStats(invoiceNumber) {
            if (confirm('Удалить инвойс из статистики?')) {
                confirmedInvoices = confirmedInvoices.filter(inv => inv.number !== invoiceNumber);
                updateStatistics();
                addLog(`Инвойс #${invoiceNumber} удален из статистики`);
                showAlert('Инвойс удален из статистики!', 'success');
            }
        }

        function viewConfirmedInvoice(invoiceIndex) {
            const invoice = confirmedInvoices[invoiceIndex];
            if (!invoice) {
                showAlert('Инвойс не найден!', 'danger');
                return;
            }

            // Создаем модальное окно для просмотра
            const modalHTML = `
                <div id="invoiceViewModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
                        <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e9ecef; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #212529;">Просмотр инвойса #${invoice.number}</h3>
                            <div>
                                <button class="btn btn-primary" onclick="exportModalInvoiceToPDF()">Экспорт PDF</button>
                                <button class="btn btn-success" onclick="copyInvoiceData(${invoiceIndex})">Копировать данные</button>
                                <button class="btn btn-danger" onclick="closeInvoiceViewModal()">Закрыть</button>
                            </div>
                        </div>
                        <div id="modalInvoiceContent" style="padding: 20px;">
                            ${generateInvoiceHTML(invoice)}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Сохраняем данные инвойса для экспорта
            window.currentModalInvoice = invoice;
        }

        function closeInvoiceViewModal() {
            const modal = document.getElementById('invoiceViewModal');
            if (modal) {
                modal.remove();
            }
            window.currentModalInvoice = null;
        }

        function exportModalInvoiceToPDF() {
            if (!window.currentModalInvoice) {
                showAlert('Нет данных для экспорта!', 'danger');
                return;
            }

            const invoice = window.currentModalInvoice;
            const invoiceContent = generateInvoiceHTML(invoice);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Рачун ${invoice.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            }
            
            showAlert('Инвойс готов для экспорта!', 'success');
        }

        function copyInvoiceData(invoiceIndex) {
            const invoice = confirmedInvoices[invoiceIndex];
            if (!invoice) {
                showAlert('Инвойс не найден!', 'danger');
                return;
            }

            // Переключаемся на вкладку создания инвойса
            showTab('invoice');
            
            // Закрываем модальное окно если оно открыто
            closeInvoiceViewModal();

            // Генерируем новый номер инвойса
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            const newInvoiceNumber = `${confirmedInvoices.length + 1}-${dateStr}`;

            // Заполняем основные данные (с новым номером и текущей датой)
            document.getElementById('invoiceNumber').value = newInvoiceNumber;
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Устанавливаем срок оплаты через 7 дней
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('invoiceDueDate').value = nextWeek.toISOString().split('T')[0];

            // Находим индекс клиента
            const clientIndex = clients.findIndex(c => c.name === invoice.client.name && c.mb === invoice.client.mb);
            if (clientIndex !== -1) {
                document.getElementById('invoiceClientSearch').value = invoice.client.name;
                document.getElementById('invoiceClient').value = clientIndex;
            }

            // Устанавливаем способ доставки и НДС
            document.getElementById('invoiceDelivery').value = invoice.delivery;
            document.getElementById('invoiceVAT').value = invoice.vatRate;

            // Устанавливаем адрес доставки если он отличается
            if (invoice.isDifferentDeliveryAddress) {
                document.getElementById('differentDeliveryAddress').checked = true;
                document.getElementById('deliveryAddressSection').style.display = 'block';
                
                // Здесь можно добавить логику для заполнения полей адреса доставки
                // если у вас есть структурированные данные адреса доставки в invoice
            }

            // Очищаем текущие товары и добавляем товары из инвойса
            const container = document.getElementById('invoiceItems');
            container.innerHTML = '';

            invoice.items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.code === item.product.code);
                
                if (productIndex !== -1) {
                    const newItem = document.createElement('div');
                    newItem.className = 'invoice-items';
                    newItem.innerHTML = `
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Товар *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="Введите код или название товара..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                                <input type="hidden" class="invoice-product" value="${productIndex}">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Количество</label>
                            <input type="number" class="invoice-quantity" value="${item.quantity}" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Цена (RSD)</label>
                            <input type="number" class="invoice-price" value="${item.price.toFixed(2)}" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Сумма (RSD)</label>
                            <input type="number" class="invoice-amount" value="${item.amount.toFixed(2)}" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">Удалить</button>
                        </div>
                    `;
                    container.appendChild(newItem);
                    
                    // Инициализируем поиск для нового поля
                    const newSearch = newItem.querySelector('.invoice-product-search');
                    setupProductSearch(newSearch);
                }
            });

            // Пересчитываем итоги
            calculateInvoiceTotals();

            showAlert('Данные инвойса скопированы! Обновлены номер и дата.', 'success');
        }

        function exportStatisticsToPDF() {
            const fromDate = document.getElementById('statsFromDate').value;
            const toDate = document.getElementById('statsToDate').value;
            
            if (!fromDate || !toDate) { 
                showAlert('Выберите период!', 'danger'); 
                return; 
            }
            
            const filteredInvoices = confirmedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999);
                return invoiceDate >= from && invoiceDate <= to;
            });

            if (filteredInvoices.length === 0) { 
                showAlert('Нет данных для экспорта!', 'danger'); 
                return; 
            }
            
            const reportContent = generatePDFReport(filteredInvoices, fromDate, toDate);
            
            const printWindow = window.open('', '_blank');
            if(printWindow) {
                printWindow.document.write(reportContent);
                printWindow.document.close();
                setTimeout(() => { printWindow.print(); }, 500);
            }
            
            showAlert('PDF отчет создан и готов к скачиванию!', 'success');
        }

        function generatePDFReport(invoices, fromDate, toDate) {
            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoicesCount = invoices.length;
            const uniqueClients = new Set(invoices.map(inv => inv.client.name)).size;
            const averageOrder = totalInvoicesCount > 0 ? totalRevenue / totalInvoicesCount : 0;

            // Статистика по товарам
            const productData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const key = item.product.code;
                    if (!productData[key]) {
                        productData[key] = {
                            name: item.product.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity;
                    productData[key].revenue += item.amount;
                });
            });

            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            // Статистика по клиентам
            const clientData = {};
            invoices.forEach(invoice => {
                const clientName = invoice.client.name;
                clientData[clientName] = (clientData[clientName] || 0) + invoice.total;
            });

            const topClients = Object.entries(clientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Статистика по месяцам
            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('sr-RS');
            };

            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];

            // Генерация диаграммы выручки по месяцам (текстовая)
            let monthlyChartHTML = '';
            if (Object.keys(monthlyData).length > 0) {
                const maxValue = Math.max(...Object.values(monthlyData));
                Object.entries(monthlyData).forEach(([monthKey, value]) => {
                    const [year, month] = monthKey.split('-');
                    const monthName = months[parseInt(month) - 1];
                    const percentage = (value / maxValue) * 100;
                    monthlyChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${monthName} ${year}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 20px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #212529, #343a40); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${((value / totalRevenue) * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
            }

            // Генерация диаграммы товаров
            let productsChartHTML = '';
            if (topProducts.length > 0) {
                const maxRevenue = topProducts[0][1].revenue;
                topProducts.forEach(([code, data]) => {
                    const percentage = (data.revenue / maxRevenue) * 100;
                    const revenuePercentage = ((data.revenue / totalRevenue) * 100).toFixed(1);
                    productsChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${code}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${data.name}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${data.quantity}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${data.revenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 15px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #28a745, #20c997); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${revenuePercentage}%</td>
                        </tr>
                    `;
                });
            }

            // Генерация диаграммы клиентов
            let clientsChartHTML = '';
            if (topClients.length > 0) {
                const maxRevenue = topClients[0][1];
                topClients.forEach(([clientName, revenue]) => {
                    const percentage = (revenue / maxRevenue) * 100;
                    const revenuePercentage = ((revenue / totalRevenue) * 100).toFixed(1);
                    const orderCount = invoices.filter(inv => inv.client.name === clientName).length;
                    clientsChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${clientName}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${revenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${orderCount}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 15px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #212529, #343a40); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${revenuePercentage}%</td>
                        </tr>
                    `;
                });
            }

            let invoicesListHTML = '';
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(invoice => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                invoicesListHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 6px; border: 1px solid #ddd;"><strong>${invoice.number}</strong></td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${date}</td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${invoice.client.name}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${invoice.items.length}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${invoice.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${invoice.vatRate}%</td>
                    </tr>
                `;
            });

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отчет по продажам</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 11px; line-height: 1.3; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #212529; padding-bottom: 15px; }
                        .logo { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; page-break-inside: avoid; }
                        th { background: #212529; color: white; padding: 8px; text-align: left; font-size: 10px; }
                        td { border: 1px solid #ddd; padding: 6px; font-size: 10px; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
                        .stat-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; text-align: center; border-left: 3px solid #212529; }
                        .stat-number { font-size: 16px; font-weight: bold; color: #212529; margin-bottom: 3px; }
                        .stat-label { font-size: 9px; color: #666; }
                        h2 { color: #212529; border-bottom: 1px solid #212529; padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 14px; }
                        h3 { color: #212529; margin: 15px 0 8px 0; font-size: 12px; }
                        .section { page-break-inside: avoid; margin-bottom: 20px; }
                        .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #212529; color: #666; font-size: 9px; }
                    </style>
                </head>
                <body>
                    <!-- Заголовок с логотипом -->
                    <div class="header">
                        <div class="logo">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="Среħа 2024 ДОО" style="width: 60px; height: auto; background: #000; border-radius: 8px; padding: 6px;">
                            <div style="text-align: left;">
                                <h1 style="margin: 0; color: #212529; font-size: 18px;">Среħа 2024 ДОО</h1>
                                <p style="margin: 2px 0; color: #666; font-size: 10px;">Београд, Стари Град, Мајке Јевросиме 35</p>
                                <p style="margin: 2px 0; color: #666; font-size: 10px;">МБ: 22019309 | ПИБ: 114407658</p>
                            </div>
                        </div>
                        <h2 style="margin: 10px 0 5px 0; font-size: 16px; border: none;">ОТЧЕТ ПО ПРОДАЖАМ</h2>
                        <p style="margin: 0; color: #666; font-size: 11px;">
                            Период: ${formatDate(fromDate)} - ${formatDate(toDate)} | 
                            Сгенерировано: ${new Date().toLocaleDateString('sr-RS')} в ${new Date().toLocaleTimeString('sr-RS')}
                        </p>
                    </div>

                    <!-- Общая статистика -->
                    <div class="section">
                        <h2>КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ</h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-number">${totalRevenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</div>
                                <div class="stat-label">Общая выручка</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${totalInvoicesCount}</div>
                                <div class="stat-label">Количество инвойсов</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${uniqueClients}</div>
                                <div class="stat-label">Уникальных клиентов</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${averageOrder.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</div>
                                <div class="stat-label">Средний заказ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Выручка по месяцам -->
                    ${Object.keys(monthlyData).length > 0 ? `
                    <div class="section">
                        <h2>ВЫРУЧКА ПО МЕСЯЦАМ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Месяц</th>
                                    <th>Выручка</th>
                                    <th>Диаграмма</th>
                                    <th>% от общей</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- Топ товаров -->
                    ${topProducts.length > 0 ? `
                    <div class="section">
                        <h2>ТОП ТОВАРОВ ПО ПРОДАЖАМ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Код</th>
                                    <th>Название</th>
                                    <th>Кол-во</th>
                                    <th>Выручка</th>
                                    <th>Диаграмма</th>
                                    <th>% от общей</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- Топ клиентов -->
                    ${topClients.length > 0 ? `
                    <div class="section">
                        <h2>ТОП КЛИЕНТОВ ПО ВЫРУЧКЕ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Клиент</th>
                                    <th>Выручка</th>
                                    <th>Заказов</th>
                                    <th>Диаграмма</th>
                                    <th>% от общей</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clientsChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- Детализация инвойсов -->
                    <div class="section">
                        <h2>ДЕТАЛИЗАЦИЯ ПО ИНВОЙСАМ</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>№ Инвойса</th>
                                    <th>Дата</th>
                                    <th>Клиент</th>
                                    <th>Товаров</th>
                                    <th>Сумма</th>
                                    <th>НДС</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoicesListHTML}
                            </tbody>
                        </table>
                    </div>

                    <!-- Подвал -->
                    <div class="footer">
                        <p><strong>Среħа 2024 ДОО</strong> | Београд, Стари Град, Мајке Јевросиме 35 | МБ: 22019309 | ПИБ: 114407658</p>
                        <p>Этот отчет содержит ${totalInvoicesCount} инвойсов на общую сумму ${totalRevenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                    </div>
                </body>
                </html>
            `;
        }

        // Обработчики событий
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('invoice-quantity')) {
                const row = e.target.closest('.invoice-items');
                const hiddenProduct = row.querySelector('.invoice-product');
                const productIndex = hiddenProduct.value;
                
                if (productIndex !== '') {
                    const product = products[productIndex];
                    const quantity = parseInt(e.target.value) || 1;
                    const amountInput = row.querySelector('.invoice-amount');
                    amountInput.value = (product.price * quantity).toFixed(2);
                }
                calculateInvoiceTotals();
            }

            if (e.target.id === 'invoiceVAT') {
                calculateInvoiceTotals();
            }
        });

        // Логи действий
        function addLog(message) {
            const logsList = document.getElementById('logsList');
            const li = document.createElement('li');
            li.textContent = message;
            logsList.appendChild(li);
            logsList.scrollTop = logsList.scrollHeight;
        }

        function clearLogs() {
            if(confirm('Очистить все логи?')) {
                localStorage.removeItem('actionLogs');
                updateLogsList();
            }
        }

        function exportLogsToExcel() {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            
            if (logs.length === 0) {
                showAlert('Нет логов для экспорта!', 'danger');
                return;
            }

            // Создаем CSV контент
            let csvContent = '\uFEFF'; // BOM для правильного отображения кириллицы в Excel
            csvContent += 'Время,Действие\n';
            
            logs.forEach(log => {
                // Экранируем кавычки и переносы строк
                const time = `"${log.time.replace(/"/g, '""')}"`;
                const action = `"${log.action.replace(/"/g, '""')}"`;
                csvContent += `${time},${action}\n`;
            });

            // Создаем Blob с типом для Excel
            const blob = new Blob([csvContent], { 
                type: 'application/vnd.ms-excel;charset=utf-8;' 
            });
            
            // Создаем ссылку для скачивания
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // Генерируем имя файла с текущей датой
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
            const filename = `logs_${dateStr}_${timeStr}.csv`;
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // Добавляем в DOM, кликаем и удаляем
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Освобождаем URL
            URL.revokeObjectURL(url);
            
            addLog(`Экспортировано ${logs.length} записей логов в файл ${filename}`);
            showAlert(`Логи экспортированы в файл ${filename}!`, 'success');
        }

        function authenticate() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Проверяем основного администратора
            if (username === 'BrankoFND' && password === 'MoskvaSlezamNeVeryt2024') {
                window.currentUser = {
                    username: 'BrankoFND',
                    isAdmin: true,
                    permissions: {
                        clients: true,
                        products: true,
                        warehouse: true,
                        invoice: true,
                        delivery: true,
                        statistics: true,
                        logs: true,
                        editUsers: true
                    }
                };
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog('Администратор вошел в систему');
                document.getElementById('loginError').style.display = 'none';
                return;
            }
            
            // Проверяем дефолтного пользователя
            if (username === 'тест' && password === 'тест') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                const defaultPermissions = {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: false
                };
                
                window.currentUser = {
                    username: 'тест',
                    isAdmin: false,
                    permissions: builtInPermissions['тест'] || defaultPermissions
                };
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog('Пользователь вошел в систему');
                document.getElementById('loginError').style.display = 'none';
                return;
            }
            
            // Получаем список пользователей из localStorage
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const user = users.find(u => u.login === username && u.password === password);
            
            if (user) {
                window.currentUser = user;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog(`Пользователь "${username}" вошёл в систему`);
                document.getElementById('loginError').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            document.getElementById('newUserLogin').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('confirmUserPassword').value = '';
            document.getElementById('addUserError').style.display = 'none';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        function addNewUser() {
            const login = document.getElementById('newUserLogin').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const confirmPassword = document.getElementById('confirmUserPassword').value.trim();
            const errorDiv = document.getElementById('addUserError');
            
            // Валидация
            if (!login || !password || !confirmPassword) {
                errorDiv.textContent = 'Все поля обязательны для заполнения';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (login.length < 3) {
                errorDiv.textContent = 'Логин должен содержать минимум 3 символа';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 3) {
                errorDiv.textContent = 'Пароль должен содержать минимум 3 символа';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Пароли не совпадают';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Проверяем зарезервированные логины
            if (login === 'тест' || login === 'BrankoFND') {
                errorDiv.textContent = 'Этот логин зарезервирован';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Проверяем, не существует ли уже такой пользователь
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            if (users.some(user => user.login === login)) {
                errorDiv.textContent = 'Пользователь с таким логином уже существует';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Добавляем нового пользователя с правами по умолчанию
            const newUser = {
                login: login,
                password: password,
                username: login,
                isAdmin: false,
                permissions: {
                    clients: true,
                    products: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: false,
                    editUsers: false
                },
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            addLog(`Добавлен новый пользователь: ${login}`);
            showAlert('Пользователь успешно добавлен!', 'success');
            closeAddUserModal();
        }

        function openEditUsersModal() {
            // Проверяем права доступа
            if (!window.currentUser || !window.currentUser.permissions.editUsers) {
                showAlert('У вас нет прав для редактирования пользователей', 'warning');
                return;
            }
            
            document.getElementById('editUsersModal').style.display = 'block';
            loadUsersList();
        }

        function closeEditUsersModal() {
            document.getElementById('editUsersModal').style.display = 'none';
        }

        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const container = document.getElementById('usersList');
            
            let usersHTML = '';
            
            // Добавляем основного администратора
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">BF</div>
                        <div class="user-details">
                            <h5>BrankoFND</h5>
                            <p>Главный администратор</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('BrankoFND', true)">Доступ</button>
                        <button class="btn btn-danger" disabled title="Нельзя удалить администратора">Удалить</button>
                    </div>
                </div>
            `;
            
            // Добавляем тестового пользователя
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">ТУ</div>
                        <div class="user-details">
                            <h5>тест</h5>
                            <p>Тестовый пользователь</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('тест', false)">Доступ</button>
                        <button class="btn btn-danger" disabled title="Нельзя удалить тестового пользователя">Удалить</button>
                    </div>
                </div>
            `;
            
            // Добавляем пользователей из localStorage
            users.forEach((user, index) => {
                const avatar = user.login.substring(0, 2).toUpperCase();
                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ru-RU') : 'Неизвестно';
                
                usersHTML += `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-details">
                                <h5>${user.login}</h5>
                                <p>Создан: ${createdDate}</p>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-primary" onclick="editUserPermissions('${user.login}', false, ${index})">Доступ</button>
                            <button class="btn btn-danger" onclick="deleteUser(${index})">Удалить</button>
                        </div>
                    </div>
                `;
            });
            
            if (users.length === 0) {
                usersHTML += '<p style="text-align: center; color: #666; padding: 20px;">Дополнительных пользователей нет</p>';
            }
            
            container.innerHTML = usersHTML;
        }

        function deleteUser(userIndex) {
            if (confirm('Удалить этого пользователя?')) {
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const deletedUser = users[userIndex];
                
                users.splice(userIndex, 1);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                
                addLog(`Удален пользователь: ${deletedUser.login}`);
                showAlert('Пользователь удален!', 'success');
                loadUsersList();
            }
        }

        function editUserPermissions(username, isBuiltIn = false, userIndex = null) {
            window.currentEditingUser = { username, isBuiltIn, userIndex };
            
            document.getElementById('permissionsTitle').textContent = `Управление доступом - ${username}`;
            
            // Получаем текущие права пользователя
            let permissions = {};
            
            if (username === 'BrankoFND') {
                permissions = {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: true
                };
            } else if (username === 'тест') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                permissions = builtInPermissions[username] || {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: false
                };
            } else {
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const user = users[userIndex];
                permissions = user.permissions || {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: false,
                    editUsers: false
                };
            }
            
            // Заполняем чекбоксы
            document.getElementById('perm_clients').checked = permissions.clients || false;
            document.getElementById('perm_products').checked = permissions.products || false;
            document.getElementById('perm_warehouse').checked = permissions.warehouse || false;
            document.getElementById('perm_invoice').checked = permissions.invoice || false;
            document.getElementById('perm_delivery').checked = permissions.delivery || false;
            document.getElementById('perm_statistics').checked = permissions.statistics || false;
            document.getElementById('perm_logs').checked = permissions.logs || false;
            document.getElementById('perm_editUsers').checked = permissions.editUsers || false;
            
            // Блокируем права администратора для всех кроме BrankoFND
            const editUserLabel = document.getElementById('editUserPermLabel');
            if (username !== 'BrankoFND') {
                document.getElementById('perm_editUsers').disabled = true;
                editUserLabel.style.opacity = '0.5';
                editUserLabel.title = 'Только для главного администратора';
            } else {
                document.getElementById('perm_editUsers').disabled = false;
                editUserLabel.style.opacity = '1';
                editUserLabel.title = '';
            }
            
            document.getElementById('userPermissionsModal').style.display = 'block';
        }

        function closeUserPermissionsModal() {
            document.getElementById('userPermissionsModal').style.display = 'none';
            window.currentEditingUser = null;
        }

        function saveUserPermissions() {
            if (!window.currentEditingUser) return;
            
            const { username, isBuiltIn, userIndex } = window.currentEditingUser;
            
            const permissions = {
                clients: document.getElementById('perm_clients').checked,
                products: document.getElementById('perm_products').checked,
                warehouse: document.getElementById('perm_warehouse').checked,
                invoice: document.getElementById('perm_invoice').checked,
                delivery: document.getElementById('perm_delivery').checked,
                statistics: document.getElementById('perm_statistics').checked,
                logs: document.getElementById('perm_logs').checked,
                editUsers: document.getElementById('perm_editUsers').checked
            };
            
            if (username === 'BrankoFND' || username === 'тест') {
                // Для встроенных пользователей сохраняем настройки отдельно
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                builtInPermissions[username] = permissions;
                localStorage.setItem('builtInPermissions', JSON.stringify(builtInPermissions));
            } else {
                // Для обычных пользователей обновляем в основном списке
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (users[userIndex]) {
                    users[userIndex].permissions = permissions;
                    localStorage.setItem('systemUsers', JSON.stringify(users));
                }
            }
            
            addLog(`Обновлены права доступа для пользователя: ${username}`);
            showAlert('Права доступа сохранены!', 'success');
            closeUserPermissionsModal();
        }

        function initializeUserInterface() {
            // Скрываем/показываем элементы интерфейса в зависимости от прав пользователя
            if (!window.currentUser) return;
            
            const permissions = window.currentUser.permissions;
            
            // Скрываем вкладки без доступа
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                const tabName = tab.textContent.toLowerCase();
                let hasAccess = true;
                
                if (tabName.includes('клиенты')) hasAccess = permissions.clients;
                else if (tabName.includes('товары')) hasAccess = permissions.products;
                else if (tabName.includes('склад')) hasAccess = permissions.warehouse;
                else if (tabName.includes('инвойс')) hasAccess = permissions.invoice;
                else if (tabName.includes('отпремница')) hasAccess = permissions.delivery;
                else if (tabName.includes('статистика')) hasAccess = permissions.statistics;
                
                if (!hasAccess) {
                    tab.style.display = 'none';
                } else {
                    tab.style.display = 'block';
                }
            });
            
            // Скрываем кнопку логов если нет доступа
            const logsBtn = document.querySelector('[onclick="openLogsModal()"]');
            if (logsBtn) {
                if (permissions.logs) {
                    logsBtn.style.display = 'block';
                } else {
                    logsBtn.style.display = 'none';
                }
            }
            
            // Скрываем кнопку редактирования пользователей
            const editUsersBtn = document.querySelector('[onclick="openEditUsersModal()"]');
            if (editUsersBtn) {
                if (permissions.editUsers) {
                    editUsersBtn.style.display = 'block';
                } else {
                    editUsersBtn.style.display = 'none';
                }
            }
        }

        function openLogsModal() {
            // Проверяем права доступа
            if (!window.currentUser || !window.currentUser.permissions.logs) {
                showAlert('У вас нет прав для просмотра логов', 'warning');
                return;
            }
            
            document.getElementById('logsModal').style.display = 'block';
            updateLogsList(); // Обновляем список логов при открытии
        }

        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
        }

        function showClientHistory(clientName) {
            const clientInvoices = confirmedInvoices.filter(invoice => 
                invoice.client.name === clientName
            );

            document.getElementById('clientHistoryTitle').textContent = `История инвойсов клиента: ${clientName}`;
            
            if (clientInvoices.length === 0) {
                document.getElementById('clientHistoryContent').innerHTML = 
                    '<p style="text-align: center; color: #666;">У данного клиента нет утвержденных инвойсов</p>';
            } else {
                // Используем ту же функцию отображения, что и в статистике
                const tempContainer = document.createElement('div');
                tempContainer.id = 'tempClientInvoicesList';
                
                let listHTML = '';
                clientInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                    const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                    const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                    const isDelivered = invoice.delivered || false;
                    const isPaid = invoice.paid || false;
                    
                    listHTML += `
                        <div class="invoice-item">
                            <div class="invoice-info">
                                <div style="font-weight: bold; color: #212529;">Инвойс #${invoice.number}</div>
                                <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} • ${date} • ${invoice.total.toFixed(2)} RSD</div>
                                <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${invoice.items.length} • НДС: ${invoice.vatRate}%</div>
                                <div style="margin-top: 10px; display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                        <span style="color: ${isDelivered ? '#28a745' : '#6c757d'};">Доставлен</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                        <span style="color: ${isPaid ? '#28a745' : '#6c757d'};">Оплачен</span>
                                    </label>
                                </div>
                            </div>
                            <div class="invoice-actions">
                                <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="Просмотреть инвойс">Просмотр</button>
                                <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="Копировать данные в новый инвойс">Копировать</button>
                                <span class="invoice-status">Утвержден</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('clientHistoryContent').innerHTML = listHTML;
            }
            
            document.getElementById('clientHistoryModal').style.display = 'block';
            addLog(`Просмотрена история инвойсов клиента: ${clientName}`);
        }

        function closeClientHistoryModal() {
            document.getElementById('clientHistoryModal').style.display = 'none';
        }

        function updateDeliveryClientFilter() {
            const filter = document.getElementById('deliveryClientFilter');
            if (!filter) return;
            
            // Очищаем текущие опции, кроме "Все клиенты"
            filter.innerHTML = '<option value="">Все клиенты</option>';
            
            // Получаем уникальных клиентов из отпремниц
            const uniqueClients = [...new Set(confirmedDeliveries.map(delivery => delivery.client.name))];
            
            uniqueClients.forEach(clientName => {
                const option = document.createElement('option');
                option.value = clientName;
                option.textContent = clientName;
                filter.appendChild(option);
            });
        }

        function filterDeliveriesByClient() {
            const selectedClient = document.getElementById('deliveryClientFilter').value;
            
            if (!selectedClient) {
                updateDeliveriesList();
                return;
            }
            
            const filteredDeliveries = confirmedDeliveries.filter(delivery => 
                delivery.client.name === selectedClient
            );
            
            updateDeliveriesList(filteredDeliveries);
        }

        function updateDeliveriesList(deliveries = confirmedDeliveries) {
            const container = document.getElementById('confirmedDeliveriesList');
            if (!container) return;

            if (deliveries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Нет утвержденных отпремниц</p>';
                return;
            }

            let listHTML = '';
            deliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((delivery, index) => {
                const date = new Date(delivery.date).toLocaleDateString('sr-RS');
                const dueDate = new Date(delivery.dueDate).toLocaleDateString('sr-RS');
                const originalIndex = confirmedDeliveries.findIndex(del => del.number === delivery.number);
                const isSigned = delivery.signed || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Отпремница #${delivery.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${delivery.client.name} • ${date} • Срок: ${dueDate}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${delivery.items.length} • Способ: ${delivery.method}</div>
                            <div style="margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${delivery.number}', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isSigned ? '#28a745' : '#6c757d'};">Подписана</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDelivery(${originalIndex})" title="Просмотреть отпремницу">Просмотр</button>
                            <span class="invoice-status">Утверждена</span>
                            <button class="btn btn-danger" onclick="removeDelivery('${delivery.number}')">Удалить</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = listHTML;
        }

        function toggleDeliveryStatus(deliveryNumber, isChecked) {
            const delivery = confirmedDeliveries.find(del => del.number === deliveryNumber);
            if (delivery) {
                delivery.signed = isChecked;
                
                // Сохраняем обновленные данные в localStorage
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                addLog(`Отпремница #${deliveryNumber} отмечена как ${isChecked ? 'подписанная' : 'неподписанная'}`);
                
                // Обновляем отображение для изменения цвета текста
                filterDeliveriesByClient();
            }
        }

        function viewDelivery(deliveryIndex) {
            const delivery = confirmedDeliveries[deliveryIndex];
            if (!delivery) {
                showAlert('Отпремница не найдена!', 'danger');
                return;
            }
            
            // Заполняем форму данными отпремницы для просмотра
            document.getElementById('deliveryNumber').value = delivery.number;
            document.getElementById('deliveryDate').value = delivery.date;
            document.getElementById('deliveryDueDate').value = delivery.dueDate;
            document.getElementById('deliveryMethod').value = delivery.method;
            
            // Устанавливаем клиента
            const clientIndex = clients.findIndex(c => c.name === delivery.client.name);
            if (clientIndex !== -1) {
                document.getElementById('deliveryClient').value = clientIndex;
                document.getElementById('deliveryClientSearch').value = delivery.client.name;
            }
            
            showAlert('Данные отпремницы загружены для просмотра', 'success');
        }

        function removeDelivery(deliveryNumber) {
            if (confirm(`Удалить отпремницу #${deliveryNumber} из списка?`)) {
                confirmedDeliveries = confirmedDeliveries.filter(del => del.number !== deliveryNumber);
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                updateDeliveriesList();
                updateDeliveryClientFilter();
                
                // Обновляем историю клиента, если она открыта
                if (window.currentClientProfile && document.getElementById('clientHistorySection').style.display === 'block') {
                    loadClientHistory(window.currentClientProfile.name);
                }
                
                addLog(`Отпремница #${deliveryNumber} удалена из списка`);
                showAlert('Отпремница удалена из списка!', 'success');
            }
        }

        // Закрытие модального окна при клике на фон
        window.onclick = function(event) {
            const addUserModal = document.getElementById('addUserModal');
            const clientHistoryModal = document.getElementById('clientHistoryModal');
            
            if (event.target === addUserModal) {
                closeAddUserModal();
            }
            if (event.target === clientHistoryModal) {
                closeClientHistoryModal();
            }
        }

        // Проверяем авторизацию при загрузке страницы
        window.onload = function() {
            // По умолчанию показываем форму входа
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function addLog(action) {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            const now = new Date();
            logs.unshift({
                time: now.toLocaleString(),
                action
            });
            localStorage.setItem('actionLogs', JSON.stringify(logs));
        }

        function updateLogsList() {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            const logsList = document.getElementById('logsList');
            if (!logsList) return;
            logsList.innerHTML = logs.length ? logs.map(log => `<li style='padding:10px 0; border-bottom:1px solid #dee2e6;'><b>${log.time}</b>: ${log.action}</li>`).join('') : '<li style="color:#888;">Нет логов действий</li>';
        }

        // Глобальный обработчик для логирования всех кликов
        document.addEventListener('click', function(event) {
            // Не логируем клики по элементам внутри модального окна логов, чтобы избежать зацикливания
            let el = event.target;
            let inLogsModal = false;
            while (el) {
                if (el.id === 'logsModal') { inLogsModal = true; break; }
                el = el.parentElement;
            }
            if (inLogsModal) return;

            let desc = '';
            if (event.target.closest('button')) {
                const btn = event.target.closest('button');
                desc = `Клик по кнопке: "${btn.textContent.trim()}"`;
            } else if (event.target.closest('a')) {
                const a = event.target.closest('a');
                desc = `Клик по ссылке: "${a.textContent.trim()}" (${a.href})`;
            } else if (event.target.closest('input, select, textarea')) {
                const input = event.target.closest('input, select, textarea');
                desc = `Клик по полю: <${input.tagName.toLowerCase()}> (name/id: ${input.name || input.id})`;
            } else {
                desc = `Клик по элементу: <${event.target.tagName.toLowerCase()}>`;
            }
            addLog(desc);
        }, true);

        // Функции профиля клиента
        window.currentClientProfile = null;

        function toggleClientForm() {
            const formSection = document.getElementById('clientFormSection');
            const toggleBtn = document.getElementById('toggleFormBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (formSection.style.display === 'none' || formSection.style.display === '') {
                formSection.style.display = 'block';
                toggleIcon.textContent = '➖';
                toggleBtn.innerHTML = '<span id="toggleIcon">➖</span> Свернуть форму';
            } else {
                formSection.style.display = 'none';
                toggleIcon.textContent = '➕';
                toggleBtn.innerHTML = '<span id="toggleIcon">➕</span> Добавить клиента';
            }
        }

        function openClientProfile(clientIndex) {
            const client = clients[clientIndex];
            if (!client) return;
            
            window.currentClientProfile = { ...client, index: clientIndex };
            
            // Генерируем аватар из первых букв
            const avatar = client.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('clientAvatar').textContent = avatar;
            
            // Заполняем основную информацию
            document.getElementById('profileClientName').textContent = client.name || '-';
            document.getElementById('profileClientLegalName').textContent = client.legalName || '-';
            document.getElementById('profileClientMB').textContent = client.mb || '-';
            document.getElementById('profileClientPIB').textContent = client.pib || '-';
            document.getElementById('profileClientContactPerson').textContent = client.contactPerson || '-';
            document.getElementById('profileClientBank').textContent = client.bank || '-';
            
            // Заполняем адрес
            document.getElementById('profileClientAddress').textContent = client.address || '-';
            const googleMapsBtn = document.getElementById('profileGoogleMapsBtn');
            if (client.googleMaps) {
                googleMapsBtn.style.display = 'block';
                googleMapsBtn.onclick = () => window.open(client.googleMaps, '_blank');
            } else {
                googleMapsBtn.style.display = 'none';
            }
            
            // Заполняем контактные данные
            const contactFields = [
                { id: 'contactPhone', valueId: 'profileClientPhone', value: client.phone },
                { id: 'contactEmail', valueId: 'profileClientEmail', value: client.email },
                { id: 'contactTelegram', valueId: 'profileClientTelegram', value: client.telegram },
                { id: 'contactInstagram', valueId: 'profileClientInstagram', value: client.instagram }
            ];
            
            contactFields.forEach(field => {
                const element = document.getElementById(field.id);
                const valueElement = document.getElementById(field.valueId);
                if (field.value) {
                    element.style.display = 'flex';
                    valueElement.textContent = field.value;
                } else {
                    element.style.display = 'none';
                }
            });
            
            // Заполняем условия сотрудничества
            const collaborationTags = document.getElementById('collaborationTags');
            const notesElement = document.getElementById('profileClientNotes');
            
            let tagsHTML = '';
            if (client.installment) {
                const term = client.installmentTerm ? ` (${client.installmentTerm} дней)` : '';
                tagsHTML += `<span class="collab-tag installment">Рассрочка${term}</span>`;
            }
            if (client.showcase) {
                tagsHTML += `<span class="collab-tag showcase">Витрина</span>`;
            }
            if (client.bar) {
                tagsHTML += `<span class="collab-tag bar">Бар</span>`;
            }
            
            collaborationTags.innerHTML = tagsHTML || '<span style="color: #6c757d; font-style: italic;">Нет особых условий</span>';
            
            if (client.notes) {
                notesElement.style.display = 'block';
                notesElement.textContent = client.notes;
            } else {
                notesElement.style.display = 'none';
            }
            
            // Обновляем заголовки
            document.getElementById('clientProfileTitle').textContent = client.name;
            document.getElementById('clientProfileSubtitle').textContent = `${client.legalName || client.name} • МБ: ${client.mb}`;
            
            // Показываем модальное окно
            document.getElementById('clientProfileModal').style.display = 'block';
            
            // Обновляем статистику
            updateClientStatistics();
            
            addLog(`Открыт профиль клиента: ${client.name}`);
        }

        function closeClientProfileModal() {
            document.getElementById('clientProfileModal').style.display = 'none';
            window.currentClientProfile = null;
            // Сбрасываем вид на профиль
            switchToClientProfile();
            // Сбрасываем режим просмотра
            switchToViewMode();
        }

        function switchToClientHistory() {
            if (!window.currentClientProfile) return;
            
            // Скрываем профиль и показываем историю
            document.getElementById('profile-sections').style.display = 'none';
            document.getElementById('viewModeFooter').style.display = 'none';
            document.getElementById('clientHistorySection').style.display = 'block';
            
            // Обновляем заголовок истории
            const client = window.currentClientProfile;
            const avatar = client.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('historyClientAvatar').textContent = avatar;
            document.getElementById('historyClientTitle').textContent = `История заказов`;
            document.getElementById('historyClientSubtitle').textContent = `${client.name} • Инвойсы и отпремницы`;
            
            // Загружаем историю заказов
            loadClientHistory(client.name);
            
            addLog(`Просмотрена история заказов клиента: ${client.name}`);
        }

        function switchToClientProfile() {
            // Показываем профиль и скрываем историю
            document.getElementById('profile-sections').style.display = 'grid';
            document.getElementById('viewModeFooter').style.display = 'block';
            document.getElementById('clientHistorySection').style.display = 'none';
            // Скрываем форму редактирования если она была открыта
            document.getElementById('edit-sections').style.display = 'none';
            document.getElementById('editModeFooter').style.display = 'none';
        }

        function switchToEditMode() {
            if (!window.currentClientProfile) return;
            
            const client = clients[window.currentClientProfile.index];
            if (!client) return;
            
            // Заполняем форму редактирования данными клиента
            document.getElementById('editClientName').value = client.name || '';
            document.getElementById('editClientLegalName').value = client.legalName || '';
            document.getElementById('editClientMB').value = client.mb || '';
            document.getElementById('editClientPIB').value = client.pib || '';
            document.getElementById('editClientContactPerson').value = client.contactPerson || '';
            document.getElementById('editClientBank').value = client.bank || '';
            
            // Адрес
            const isManualAddress = client.isManualAddress || false;
            document.getElementById('editManualAddressInput').checked = isManualAddress;
            
            if (isManualAddress) {
                document.getElementById('editAutoAddressSection').style.display = 'none';
                document.getElementById('editManualAddressSection').style.display = 'block';
                document.getElementById('editClientManualAddress').value = client.address || '';
            } else {
                document.getElementById('editAutoAddressSection').style.display = 'block';
                document.getElementById('editManualAddressSection').style.display = 'none';
                document.getElementById('editClientCity').value = client.city || '';
                document.getElementById('editClientMunicipality').value = client.municipality || '';
                document.getElementById('editClientStreet').value = client.street || '';
                document.getElementById('editClientHouseNumber').value = client.houseNumber || '';
            }
            
            document.getElementById('editClientGoogleMaps').value = client.googleMaps || '';
            
            // Контактные данные
            document.getElementById('editClientPhone').value = client.phone || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientTelegram').value = client.telegram || '';
            document.getElementById('editClientInstagram').value = client.instagram || '';
            
            // Условия сотрудничества
            document.getElementById('editClientInstallment').checked = client.installment || false;
            document.getElementById('editClientInstallmentTerm').value = client.installmentTerm || '';
            document.getElementById('editClientShowcase').checked = client.showcase || false;
            document.getElementById('editClientBar').checked = client.bar || false;
            document.getElementById('editClientNotes').value = client.notes || '';
            
            // Обработчик переключения типа адреса
            document.getElementById('editManualAddressInput').onchange = function() {
                if (this.checked) {
                    document.getElementById('editAutoAddressSection').style.display = 'none';
                    document.getElementById('editManualAddressSection').style.display = 'block';
                } else {
                    document.getElementById('editAutoAddressSection').style.display = 'block';
                    document.getElementById('editManualAddressSection').style.display = 'none';
                }
            };
            
            // Переключаем интерфейс
            document.getElementById('profile-sections').style.display = 'none';
            document.getElementById('viewModeFooter').style.display = 'none';
            document.getElementById('edit-sections').style.display = 'block';
            document.getElementById('editModeFooter').style.display = 'block';
            
            addLog(`Открыто редактирование клиента: ${client.name}`);
        }

        function switchToViewMode() {
            // Переключаемся обратно к режиму просмотра
            document.getElementById('profile-sections').style.display = 'grid';
            document.getElementById('viewModeFooter').style.display = 'block';
            document.getElementById('edit-sections').style.display = 'none';
            document.getElementById('editModeFooter').style.display = 'none';
        }

        function loadClientHistory(clientName) {
            // Загружаем данные для обеих вкладок
            loadClientInvoices(clientName);
            loadClientDeliveries(clientName);
            
            // Обновляем счетчики в вкладках
            updateHistoryTabCounts(clientName);
        }

        function loadClientInvoices(clientName) {
            const clientInvoices = confirmedInvoices.filter(invoice => invoice.client.name === clientName);
            const contentElement = document.getElementById('clientInvoicesContent');
            
            if (clientInvoices.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">У данного клиента пока нет инвойсов</p>';
                return;
            }

            let listHTML = '';
            clientInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                const isDelivered = invoice.delivered || false;
                const isPaid = invoice.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Инвойс #${invoice.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} • ${date} • ${invoice.total.toFixed(2)} RSD</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${invoice.items.length} • НДС: ${invoice.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isDelivered ? '#333' : '#6c757d'};">Доставлен</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isPaid ? '#333' : '#6c757d'};">Оплачен</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="Просмотреть инвойс">Просмотр</button>
                            <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="Копировать данные в новый инвойс">Копировать</button>
                            <span class="invoice-status">Утвержден</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function loadClientDeliveries(clientName) {
            const clientDeliveries = confirmedDeliveries.filter(delivery => delivery.client.name === clientName);
            const contentElement = document.getElementById('clientDeliveriesContent');
            
            if (clientDeliveries.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">У данного клиента пока нет отпремниц</p>';
                return;
            }

            let listHTML = '';
            clientDeliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((delivery, index) => {
                const date = new Date(delivery.date).toLocaleDateString('sr-RS');
                const dueDate = new Date(delivery.dueDate).toLocaleDateString('sr-RS');
                const originalIndex = confirmedDeliveries.findIndex(del => del.number === delivery.number);
                const isSigned = delivery.signed || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">Отпремница #${delivery.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${delivery.client.name} • ${date} • Срок: ${dueDate}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">Товаров: ${delivery.items.length} • Способ: ${delivery.method}</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${delivery.number}', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isSigned ? '#333' : '#6c757d'};">Подписана</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDeliveryFromHistory(${originalIndex})" title="Просмотреть отпремницу">Просмотр</button>
                            <span class="invoice-status">Утверждена</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function updateHistoryTabCounts(clientName) {
            const invoicesCount = confirmedInvoices.filter(invoice => invoice.client.name === clientName).length;
            const deliveriesCount = confirmedDeliveries.filter(delivery => delivery.client.name === clientName).length;
            
            document.getElementById('invoicesCount').textContent = invoicesCount;
            document.getElementById('deliveriesCount').textContent = deliveriesCount;
        }

        function switchHistoryTab(tab) {
            // Убираем активный класс со всех вкладок
            document.querySelectorAll('.history-tab').forEach(tabEl => tabEl.classList.remove('active'));
            
            // Скрываем все контенты
            document.getElementById('clientInvoicesContent').style.display = 'none';
            document.getElementById('clientDeliveriesContent').style.display = 'none';
            
            if (tab === 'invoices') {
                document.getElementById('invoicesTab').classList.add('active');
                document.getElementById('clientInvoicesContent').style.display = 'block';
            } else if (tab === 'deliveries') {
                document.getElementById('deliveriesTab').classList.add('active');
                document.getElementById('clientDeliveriesContent').style.display = 'block';
            }
        }



        function viewDeliveryFromHistory(deliveryIndex) {
            const delivery = confirmedDeliveries[deliveryIndex];
            if (!delivery) return;
            
            // Открываем модальное окно просмотра отпремницы (аналогично инвойсам)
            showDeliveryModal(delivery, deliveryIndex);
        }

        function showDeliveryModal(delivery, deliveryIndex) {
            const modalHTML = `
                <div class="modal" id="deliveryViewModal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 class="modal-title">Отпремница #${delivery.number}</h2>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-primary" onclick="printDeliveryFromModal()">Экспорт PDF</button>
                                <button class="btn btn-danger" onclick="closeDeliveryViewModal()">Закрыть</button>
                            </div>
                        </div>
                        <div id="modalDeliveryContent" style="padding: 20px;">
                            ${generateDeliveryHTMLForModal(delivery)}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Сохраняем данные отпремницы для экспорта
            window.currentModalDelivery = delivery;
        }

        function generateDeliveryHTMLForModal(delivery) {
            let itemsHTML = '';
            delivery.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.product.unit || 'ком'}</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">Среħа 2024 ДОО Београд (Стари Град)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matični broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedište: Beograd, Stari Grad, Мајке Јевросиме 35</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">ОТПРЕМНИЦА</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${delivery.number}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Поручилац:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${delivery.client.legalName || delivery.client.name}</p>
                                <p style="margin: 0;">Matični broj: ${delivery.client.mb}</p>
                                <p style="margin: 0;">PIB: ${delivery.client.pib}</p>
                                <p style="margin: 0;">Sedište: ${delivery.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Испорука на адресу:</h4>
                            <p style="margin: 0; font-size: 10px;">${delivery.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Начин:</strong> ${delivery.method}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Дата:</strong> ${new Date(delivery.date).toLocaleDateString('sr-RS')}</p>
                        <p style="margin: 2px 0; font-size: 10px;"><strong>Рок испоруке:</strong> ${new Date(delivery.dueDate).toLocaleDateString('sr-RS')}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Назив артикла</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Количина</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">Јединица мере</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Издао</strong></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>Примио</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        Овај документ је генерисан електронски и важи без печата и потписа
                    </div>
                </div>
            `;
        }

        function closeDeliveryViewModal() {
            const modal = document.getElementById('deliveryViewModal');
            if (modal) {
                document.body.removeChild(modal);
                window.currentModalDelivery = null;
            }
        }

        function printDeliveryFromModal() {
            if (!window.currentModalDelivery) {
                showAlert('Нет данных для экспорта!', 'danger');
                return;
            }

            const delivery = window.currentModalDelivery;
            const deliveryContent = generateDeliveryHTMLForModal(delivery);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Отпремница ${delivery.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 10mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;

            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Отпремница_${delivery.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog(`Экспортирована отпремница #${delivery.number}`);
        }

        function exportClientHistoryToPDF() {
            if (!window.currentClientProfile) return;
            
            const client = window.currentClientProfile;
            showAlert('Функция экспорта истории заказов в PDF будет реализована в следующих версиях', 'info');
            addLog(`Экспорт истории заказов в PDF: ${client.name}`);
        }



        function saveClientChanges() {
            if (!window.currentClientProfile) return;
            
            const clientIndex = window.currentClientProfile.index;
            const client = clients[clientIndex];
            if (!client) return;
            
            // Получаем данные из формы
            const name = document.getElementById('editClientName').value.trim();
            const legalName = document.getElementById('editClientLegalName').value.trim();
            const mb = document.getElementById('editClientMB').value.trim();
            const pib = document.getElementById('editClientPIB').value.trim();
            const contactPerson = document.getElementById('editClientContactPerson').value.trim();
            const bank = document.getElementById('editClientBank').value.trim();
            const isManualInput = document.getElementById('editManualAddressInput').checked;
            
            // Новые поля
            const googleMaps = document.getElementById('editClientGoogleMaps').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const telegram = document.getElementById('editClientTelegram').value.trim();
            const instagram = document.getElementById('editClientInstagram').value.trim();
            const installment = document.getElementById('editClientInstallment').checked;
            const installmentTerm = document.getElementById('editClientInstallmentTerm').value.trim();
            const showcase = document.getElementById('editClientShowcase').checked;
            const bar = document.getElementById('editClientBar').checked;
            const notes = document.getElementById('editClientNotes').value.trim();
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                address = document.getElementById('editClientManualAddress').value.trim();
                if (!name || !legalName || !mb || !pib || !address) {
                    showAlert('Заполните обязательные поля!', 'danger');
                    return;
                }
                // Парсим адрес для базовой структуры
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
            } else {
                city = document.getElementById('editClientCity').value.trim();
                municipality = document.getElementById('editClientMunicipality').value.trim();
                street = document.getElementById('editClientStreet').value.trim();
                houseNumber = document.getElementById('editClientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) {
                    showAlert('Заполните обязательные поля!', 'danger');
                    return;
                }
                
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            // Проверяем уникальность МБ и ПИБ (исключая текущего клиента)
            const existingClient = clients.find((c, index) => 
                index !== clientIndex && (c.mb === mb || c.pib === pib)
            );
            
            if (existingClient) {
                showAlert('Клиент с таким МБ или ПИБ уже существует!', 'danger');
                return;
            }
            
            // Обновляем данные клиента
            const oldName = client.name;
            clients[clientIndex] = {
                ...client,
                name,
                legalName,
                mb,
                pib,
                address,
                bank,
                city,
                municipality,
                street,
                houseNumber,
                isManualAddress: isManualInput,
                googleMaps,
                contactPerson,
                phone,
                email,
                telegram,
                instagram,
                installment,
                installmentTerm,
                showcase,
                bar,
                notes,
                contact: contactPerson || phone || email || ''
            };
            
            // Сохраняем в localStorage
            localStorage.setItem('clients', JSON.stringify(clients));
            
            // Обновляем интерфейс
            renderClientsTable();
            updateSelectOptions();
            
            // Обновляем текущий профиль если он открыт
            window.currentClientProfile = { ...clients[clientIndex], index: clientIndex };
            
            // Обновляем отображение профиля
            if (document.getElementById('clientProfileModal').style.display === 'block') {
                openClientProfile(clientIndex);
                // Возвращаемся к режиму просмотра
                switchToViewMode();
            }
            
            addLog(`Обновлен клиент: ${oldName} → ${name}`);
            showAlert('Данные клиента успешно обновлены!', 'success');
        }

        function openGoogleMaps() {
            if (window.currentClientProfile && window.currentClientProfile.googleMaps) {
                window.open(window.currentClientProfile.googleMaps, '_blank');
            }
        }

        function updateClientStatistics() {
            if (!window.currentClientProfile) return;
            
            const clientName = window.currentClientProfile.name;
            const period = document.getElementById('statisticsPeriod').value;
            
            // Получаем инвойсы клиента
            const clientInvoices = confirmedInvoices.filter(invoice => invoice.client.name === clientName);
            
            // Фильтруем по периоду
            let filteredInvoices = clientInvoices;
            const now = new Date();
            
            if (period === 'year') {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfYear);
            } else if (period === 'quarter') {
                const currentQuarter = Math.floor(now.getMonth() / 3);
                const startOfQuarter = new Date(now.getFullYear(), currentQuarter * 3, 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfQuarter);
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfMonth);
            }
            
            // Считаем статистику
            const invoiceCount = filteredInvoices.length;
            const totalSum = filteredInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const avgOrderValue = invoiceCount > 0 ? totalSum / invoiceCount : 0;
            
            // Находим самый популярный продукт
            const productCounts = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const productName = item.name || item.product?.name || 'Неизвестный продукт';
                    productCounts[productName] = (productCounts[productName] || 0) + item.quantity;
                });
            });
            
            let topProduct = '-';
            let maxCount = 0;
            for (const [product, count] of Object.entries(productCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topProduct = product;
                }
            }
            
            // Годовое потребление (всегда за год)
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const yearlyInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfYear);
            const yearlyConsumption = yearlyInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            
            // Обновляем UI
            document.getElementById('clientAvgOrderValue').textContent = avgOrderValue.toFixed(2) + ' RSD';
            document.getElementById('clientInvoiceCount').textContent = invoiceCount;
            document.getElementById('clientTopProduct').textContent = topProduct;
            document.getElementById('clientYearlyConsumption').textContent = yearlyConsumption.toFixed(2) + ' RSD';
        }

        // Обработчики для поиска товаров в группах
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('group-product-search')) {
                const searchInput = event.target;
                const groupId = searchInput.id.replace('groupProductSearch-', '');
                const dropdown = document.getElementById(`groupProductDropdown-${groupId}`);
                const hiddenInput = document.getElementById(`groupProductCode-${groupId}`);
                const query = searchInput.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    hiddenInput.value = '';
                    return;
                }
                
                // Фильтруем товары с весом по коду или названию
                const filteredProducts = products.filter(product => 
                    product.weight > 0 && (
                        product.code.toLowerCase().includes(query) || 
                        product.name.toLowerCase().includes(query)
                    )
                ).slice(0, 10); // Ограничиваем до 10 результатов
                
                if (filteredProducts.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item disabled">Товары не найдены</div>';
                } else {
                    dropdown.innerHTML = filteredProducts.map(product => 
                        `<div class="dropdown-item" data-code="${product.code}" data-name="${product.name}" data-weight="${product.weight}">
                            <strong>${product.code}</strong> - ${product.name} (${product.weight}г)
                        </div>`
                    ).join('');
                }
                
                dropdown.style.display = 'block';
            }
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('dropdown-item') && event.target.closest('.group-product-dropdown')) {
                const item = event.target;
                const dropdown = item.closest('.group-product-dropdown');
                const groupId = dropdown.id.replace('groupProductDropdown-', '');
                const searchInput = document.getElementById(`groupProductSearch-${groupId}`);
                const hiddenInput = document.getElementById(`groupProductCode-${groupId}`);
                
                const code = item.getAttribute('data-code');
                const name = item.getAttribute('data-name');
                const weight = item.getAttribute('data-weight');
                
                searchInput.value = `${code} - ${name} (${weight}г)`;
                hiddenInput.value = code;
                dropdown.style.display = 'none';
            }
            
            // Закрытие dropdown при клике вне его
            if (!event.target.closest('.searchable-select')) {
                document.querySelectorAll('.group-product-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // Функции для подсветки обязательных полей
        function highlightRequiredFields() {
            // Находим все обязательные поля по лейблам со звездочкой
            const requiredLabels = document.querySelectorAll('label');
            
            requiredLabels.forEach(label => {
                if (label.textContent.includes('*')) {
                    // Находим связанное поле ввода
                    const fieldId = label.getAttribute('for') || label.nextElementSibling?.id;
                    let field = null;
                    
                    if (fieldId) {
                        field = document.getElementById(fieldId);
                    } else {
                        // Ищем поле ввода в том же form-group
                        const formGroup = label.closest('.form-group');
                        if (formGroup) {
                            field = formGroup.querySelector('input, select, textarea');
                        }
                    }
                    
                    if (field) {
                        field.classList.add('required-field');
                        label.classList.add('required-label');
                    }
                }
            });
        }

        function validateRequiredFields(container = document) {
            let isValid = true;
            const requiredFields = container.querySelectorAll('.required-field');
            
            requiredFields.forEach(field => {
                const value = field.value.trim();
                
                if (!value) {
                    field.classList.add('required-field-error');
                    field.classList.remove('required-field');
                    isValid = false;
                    
                    // Убираем класс ошибки через 3 секунды
                    setTimeout(() => {
                        field.classList.remove('required-field-error');
                        field.classList.add('required-field');
                    }, 3000);
                } else {
                    field.classList.remove('required-field-error');
                    field.classList.add('required-field');
                }
            });
            
            return isValid;
        }

        function resetFieldHighlighting(container = document) {
            const fields = container.querySelectorAll('.required-field, .required-field-error');
            fields.forEach(field => {
                field.classList.remove('required-field-error');
                field.classList.add('required-field');
            });
        }

        // Инициализация подсветки при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                highlightRequiredFields();
            }, 500);
        });

        // Обработчики для снятия подсветки ошибки при вводе
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('required-field-error')) {
                event.target.classList.remove('required-field-error');
                event.target.classList.add('required-field');
            }
        });

        // Закрытие модальных окон по клику вне их
        window.onclick = function(event) {
            const clientProfileModal = document.getElementById('clientProfileModal');
            const editProductModal = document.getElementById('editProductModal');
            
            if (event.target === clientProfileModal) {
                closeClientProfileModal();
            }
            
            if (event.target === editProductModal) {
                closeEditProductModal();
            }
        }
    </script>
</body>
</html>